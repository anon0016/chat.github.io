<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>P2P åŠ å¯†èŠå¤© Â· æ–‡ä»¶ä¼ è¾“ + äºŒç»´ç  + å¼ºåŒ–å¯†é’¥</title>
<style>
  :root{
    --bg:#0e1117;--fg:#e6edf3;--mut:#9da7b3;--card:#151b23;--line:#222b37;
    --accent:#7aa2f7;--ok:#34d399;--bad:#ef4444;--warn:#ffd166;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);
       font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,Arial;}
  .app{min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;}
  header{position:sticky;top:0;z-index:5;background:rgba(14,17,23,.86);
         backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--line);padding:10px 12px;}
  h1{font-size:18px;margin:0 0 2px}
  .hint{color:var(--mut);font-size:12px}
  .wrap{padding:12px 12px 108px;max-width:1100px;margin:0 auto}
  .grid{display:grid;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{
    appearance:none;cursor:pointer;border:1px solid #2a3350;background:#0f1524;color:var(--fg);
    padding:10px 14px;border-radius:12px;font-weight:600;font-size:15px;touch-action:manipulation;
  }
  .grow{flex:1}
  button.primary{background:linear-gradient(180deg,#1b2240,#12172e);border-color:#2b3564}
  button:disabled{opacity:.5}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1422;font-size:12px}
  textarea,.mono,input[type=text],input[type=password]{
    width:100%;background:#0b0f14;color:var(--fg);border:1px solid #202736;border-radius:12px;padding:10px;
    font-family:ui-monospace,Consolas,monospace;font-size:13px;
  }
  textarea{min-height:84px;resize:vertical}
  .field{display:grid;gap:8px;margin:8px 0}
  .state{display:flex;gap:8px;flex-wrap:wrap}
  .chat{
    height:34vh;max-height:40dvh;min-height:180px;overflow:auto;background:#0a0f17;border:1px solid #202736;
    border-radius:12px;padding:10px;
  }
  .me{color:#9ae6b4}.peer{color:#93c5fd}.sys{color:#fcd34d}
  .composer{
    position:fixed;left:0;right:0;bottom:0;z-index:10;background:rgba(14,17,23,.98);
    border-top:1px solid var(--line);padding:8px 10px calc(8px + env(safe-area-inset-bottom));
    display:flex;gap:8px;align-items:center;flex-wrap:wrap;
  }
  .composer input.msg{
    flex:1;min-width:240px;border:1px solid #202736;background:#0b0f14;color:var(--fg);
    border-radius:12px;padding:12px 12px;font-size:16px;
  }
  .pbar{height:8px;background:#0a0f17;border:1px solid #253049;border-radius:999px;overflow:hidden}
  .pbar>i{display:block;height:100%;background:linear-gradient(90deg,#52a9ff,#7aa2f7)}
  .qrbox{display:grid;grid-template-columns:1fr;gap:8px}
  canvas.qr{width:220px;height:220px;background:#fff;border-radius:8px}
  video#cam{width:100%;max-height:220px;border:1px solid #253049;border-radius:12px;background:#000}
  @media(min-width:900px){
    .grid{grid-template-columns:1fr 1fr}
    .wrap{padding:16px 16px 120px}
    .chat{height:420px}
  }
  .toast{
    position:fixed;left:50%;transform:translateX(-50%);bottom:calc(86px + env(safe-area-inset-bottom));
    background:#0b0f14;border:1px solid #28406e;color:#cfe3ff;padding:10px 12px;border-radius:10px;opacity:0;pointer-events:none;transition:.25s;
  }
  .toast.show{opacity:1}
  .muted{color:var(--mut)}
  .small{font-size:12px}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>ğŸ” P2P åŠ å¯†èŠå¤©ï¼ˆæ–‡ä»¶ä¼ è¾“ / äºŒç»´ç  / å¼ºåŒ–å¯†é’¥ï¼‰</h1>
    <div class="hint">WebRTC P2P Â· ECDH + HKDF + AES-GCM Â· 16å­—èŠ‚æŒ‡çº¹ Â· å¯é€‰å£ä»¤</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <details open class="card">
        <summary>â‘  å»ºç«‹è¿æ¥</summary>
        <div class="field">
          <div class="row">
            <button id="btnOffer" class="primary grow">åˆ›å»ºæˆ¿é—´ï¼ˆç”Ÿæˆ Offerï¼‰</button>
            <button id="btnAnswer" class="grow">åŠ å…¥æˆ¿é—´ï¼ˆç”¨ Offer ç”Ÿæˆ Answerï¼‰</button>
          </div>
          <div class="hint">æŠŠ Offer å‘ç»™å¯¹æ–¹ï¼›å¯¹æ–¹ç”Ÿæˆ Answer å›è´´ç»™ä½ ã€‚å¯ç”¨äºŒç»´ç ã€‚</div>
          <div class="row">
            <input type="password" id="passphrase" placeholder="å¯é€‰ï¼šè§é¢è¯ / å£ä»¤ï¼ˆåŒæ–¹ä¸€è‡´ï¼‰" />
          </div>
        </div>

        <div class="field">
          <label class="hint">æœ¬åœ° Offer</label>
          <textarea id="offerBox" readonly></textarea>
          <div class="row">
            <button id="copyOffer">å¤åˆ¶</button>
            <button id="shareOffer">åˆ†äº«</button>
            <button id="qrOffer">äºŒç»´ç </button>
          </div>
        </div>

        <div class="field">
          <label class="hint">å¯¹æ–¹ Offerï¼ˆåŠ å…¥æ–¹ç²˜è´´æˆ–æ‰«ç ï¼‰</label>
          <textarea id="remoteOffer" placeholder="ç²˜è´´å¯¹æ–¹ Offer"></textarea>
          <div class="row">
            <button id="pasteOffer">ç²˜è´´</button>
            <button id="scanOffer">æ‰«ç </button>
            <button id="clrRO">æ¸…ç©º</button>
          </div>
        </div>

        <div class="field">
          <label class="hint">æœ¬åœ° Answer</label>
          <textarea id="answerBox" readonly></textarea>
          <div class="row">
            <button id="copyAnswer">å¤åˆ¶</button>
            <button id="shareAnswer">åˆ†äº«</button>
            <button id="qrAnswer">äºŒç»´ç </button>
          </div>
        </div>

        <div class="field">
          <label class="hint">å¯¹æ–¹ Answerï¼ˆåˆ›å»ºæ–¹ç²˜è´´æˆ–æ‰«ç ï¼‰</label>
          <textarea id="remoteAnswer" placeholder="ç²˜è´´å¯¹æ–¹ Answer"></textarea>
          <div class="row">
            <button id="pasteAnswer">ç²˜è´´</button>
            <button id="scanAnswer">æ‰«ç </button>
            <button id="clrRA">æ¸…ç©º</button>
          </div>
        </div>

        <div class="state">
          <span class="pill">è¿æ¥ï¼š<b id="connState">idle</b></span>
          <span class="pill">é€šé“/æ¶ˆæ¯ï¼š<b id="dc1">-</b></span>
          <span class="pill">é€šé“/æ–‡ä»¶ï¼š<b id="dc2">-</b></span>
          <span class="pill">STUNï¼šstun.l.google.com</span>
        </div>
      </details>

      <details open class="card">
        <summary>â‘¡ åŠ å¯†çŠ¶æ€ä¸èŠå¤© / æ–‡ä»¶</summary>
        <div class="row" style="gap:6px;margin-bottom:6px">
          <span class="pill">æˆ‘çš„æŒ‡çº¹ï¼š<b class="mono" id="fpLocal">-</b></span>
          <span class="pill">å¯¹æ–¹æŒ‡çº¹ï¼š<b class="mono" id="fpPeer">-</b></span>
        </div>
        <div class="hint">è¯·ç”¨å…¶ä»–æ¸ é“æ ¸å¯¹**åŒä¸€ä¸²**æŒ‡çº¹ï¼ˆ32 ä½åå…­è¿›åˆ¶ï¼Œ16 å­—èŠ‚ï¼‰ã€‚</div>

        <div class="chat" id="chat"></div>

        <div class="field">
          <div class="row">
            <input type="file" id="fileInput">
            <button id="sendFileBtn" disabled>å‘é€æ–‡ä»¶</button>
          </div>
          <div class="small muted">å¤§æ–‡ä»¶ä¼šè‡ªåŠ¨åˆ†ç‰‡åŠ å¯†ä¼ è¾“ã€‚</div>
          <div class="row">
            <div style="flex:1">
              <div class="small">å‘é€è¿›åº¦ï¼š<span id="sendStat" class="muted">-</span></div>
              <div class="pbar"><i id="sendBar" style="width:0%"></i></div>
            </div>
            <div style="flex:1">
              <div class="small">æ¥æ”¶è¿›åº¦ï¼š<span id="recvStat" class="muted">-</span></div>
              <div class="pbar"><i id="recvBar" style="width:0%"></i></div>
            </div>
          </div>
          <div id="recvFiles" class="small"></div>
        </div>
      </details>
    </div>

    <details class="card">
      <summary>â‘¢ äºŒç»´ç é¢æ¿ / æ‰«ç ï¼ˆå¯é€‰ï¼‰</summary>
      <div class="qrbox">
        <canvas id="qrCanvas" class="qr"></canvas>
        <video id="cam" playsinline muted></video>
        <div class="row">
          <button id="stopCam">åœæ­¢æ‘„åƒå¤´</button>
        </div>
        <div class="small muted">è¯´æ˜ï¼šç”ŸæˆäºŒç»´ç ç”¨äºæŠŠ Offer/Answer ç»™å¯¹æ–¹ï¼›è‹¥è®¾å¤‡æ”¯æŒ <code>BarcodeDetector</code>ï¼Œå¯ç›´æ¥æ‰«ç å¯¼å…¥ã€‚</div>
      </div>
    </details>
  </div>

  <div class="composer">
    <input id="msg" class="msg" placeholder="è¾“å…¥æ¶ˆæ¯â€¦" autocapitalize="off" autocorrect="off" autocomplete="off" />
    <button id="sendBtn" class="primary" disabled>å‘é€</button>
  </div>

  <div id="toast" class="toast">OK</div>
</div>

<script>
/* ====== å·¥å…· ====== */
const $ = s=>document.querySelector(s);
const toast = (t)=>{
  const el=$('#toast'); el.textContent=t||'OK'; el.classList.add('show');
  if(navigator.vibrate) navigator.vibrate(10);
  clearTimeout(toast._t); toast._t=setTimeout(()=>el.classList.remove('show'),1200);
};
function fmtBytes(n){
  const u=['B','KB','MB','GB','TB']; let i=0; while(n>=1024 && i<u.length-1){n/=1024;i++}
  return n.toFixed(n<10&&i>0?2:0)+' '+u[i];
}
function addLine(who, text){
  const box=$('#chat'); const p=document.createElement('div');
  p.className=who; p.textContent=(who==='me'?'æˆ‘: ':who==='peer'?'å¯¹æ–¹: ':'')+text;
  box.appendChild(p); box.scrollTop=box.scrollHeight;
}
function b64enc(u8){return btoa(String.fromCharCode(...u8))}
function b64dec(str){return new Uint8Array([...atob(str)].map(c=>c.charCodeAt(0)))}
function hex(u8){return [...new Uint8Array(u8)].map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase()}
function pick(n){return crypto.getRandomValues(new Uint8Array(n))}
function logSys(t){addLine('sys','ğŸ›ˆ '+t)}
const sleep = ms=>new Promise(r=>setTimeout(r,ms));

/* ====== WebRTC åŸºç¡€ï¼ˆåŒé€šé“ï¼šmsg/fileï¼‰ ====== */
const cfg={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};
let pc, chMsg, chFile, isStarter=false;

async function makePC(){
  pc=new RTCPeerConnection(cfg);
  pc.oniceconnectionstatechange=()=>$('#connState').textContent=pc.iceConnectionState;
  pc.onconnectionstatechange=()=>$('#connState').textContent=pc.connectionState;
  pc.onicecandidate=e=>{
    if(e.candidate===null){
      const sdp=btoa(JSON.stringify(pc.localDescription));
      if(isStarter) $('#offerBox').value=sdp; else $('#answerBox').value=sdp;
    }
  };
  pc.ondatachannel=e=>{
    if(e.channel.label==='msg'){ chMsg=e.channel; bindMsgDC(); }
    if(e.channel.label==='file'){ chFile=e.channel; bindFileDC(); }
  };
}

function bindMsgDC(){
  chMsg.binaryType='arraybuffer';
  chMsg.onopen=async()=>{
    $('#dc1').textContent='open'; $('#sendBtn').disabled=false; $('#sendFileBtn').disabled=!(chFile&&chFile.readyState==='open');
    logSys('æ¶ˆæ¯é€šé“å·²æ‰“å¼€ï¼Œå¼€å§‹ ECDH å¯†é’¥åå•†â€¦'); await startECDH();
  };
  chMsg.onclose=()=>{$('#dc1').textContent='closed';$('#sendBtn').disabled=true;}
  chMsg.onmessage=onRawMessage;
}
function bindFileDC(){
  chFile.binaryType='arraybuffer';
  chFile.bufferedAmountLowThreshold = 1<<20; // 1MB
  chFile.onopen=()=>{
    $('#dc2').textContent='open';
    $('#sendFileBtn').disabled = !(aesKeys.file);
  };
  chFile.onclose=()=>{$('#dc2').textContent='closed'; $('#sendFileBtn').disabled=true;}
  chFile.onmessage=onRawFileMessage;
}

/* ====== ECDH + HKDFï¼šæ´¾ç”Ÿå¤šé’¥ + 16å­—èŠ‚æŒ‡çº¹ ====== */
let myECDH,myPubRaw,aesKeys={msg:null,file:null}, sessionId=null, bothFP=null;
async function startECDH(){
  myECDH=await crypto.subtle.generateKey({name:'ECDH',namedCurve:'P-256'},true,['deriveKey','deriveBits']);
  myPubRaw=await crypto.subtle.exportKey('raw',myECDH.publicKey);
  sendCtrl({type:'pub',data:b64enc(new Uint8Array(myPubRaw))});
}
async function deriveKeys(peerRaw){
  const peerKey=await crypto.subtle.importKey('raw',peerRaw,{name:'ECDH',namedCurve:'P-256'},true,[]);
  const shared=await crypto.subtle.deriveBits({name:'ECDH',public:peerKey}, myECDH.privateKey, 256); // 32B
  const sharedU8=new Uint8Array(shared);

  // HKDF(infoåˆ†ç¦»ç”¨é€”ï¼›salt= å…¬é’¥æ‹¼æ¥ + å¯é€‰å£ä»¤)
  const pubs=[new Uint8Array(myPubRaw), new Uint8Array(peerRaw)].sort((a,b)=>a[0]-b[0]||a.length-b.length);
  const cat=new Uint8Array(pubs[0].length+pubs[1].length); cat.set(pubs[0],0); cat.set(pubs[1],pubs[0].length);

  let pass = ($('#passphrase').value || '');
  const passSalt = pass ? new TextEncoder().encode(pass) : new Uint8Array(0);
  const saltCat = new Uint8Array(cat.length + passSalt.length); saltCat.set(cat,0); saltCat.set(passSalt,cat.length);

  async function hkdfExpand(infoStr, len){
    // WebCrypto HKDF é€šè¿‡ importKey + deriveBits ç»„åˆ
    const baseKey = await crypto.subtle.importKey('raw', sharedU8, {name:'HKDF'}, false, ['deriveBits']);
    const bits = await crypto.subtle.deriveBits(
      {name:'HKDF', hash:'SHA-256', salt: await crypto.subtle.digest('SHA-256', saltCat), info:new TextEncoder().encode(infoStr)},
      baseKey, len*8
    );
    return new Uint8Array(bits);
  }
  const keyMsgRaw = await hkdfExpand('p2p/msg', 32);
  const keyFileRaw = await hkdfExpand('p2p/file', 32);
  const sidRaw    = await hkdfExpand('p2p/sessionId', 32); // ä¼šè¯æ ‡è¯†ï¼ˆéå¯†é’¥ï¼‰

  aesKeys.msg  = await crypto.subtle.importKey('raw', keyMsgRaw,  {name:'AES-GCM'}, false, ['encrypt','decrypt']);
  aesKeys.file = await crypto.subtle.importKey('raw', keyFileRaw, {name:'AES-GCM'}, false, ['encrypt','decrypt']);
  sessionId = sidRaw;

  // æŒ‡çº¹ï¼šSHA-256(cat || keyMsgRaw) å–å‰ 16 å­—èŠ‚
  const fpBuf = await crypto.subtle.digest('SHA-256', new Uint8Array([...cat, ...keyMsgRaw]));
  const fp = hex(new Uint8Array(fpBuf).slice(0,16));
  bothFP = fp;
  $('#fpLocal').textContent=fp;
  sendCtrl({type:'fp',data:fp});
  logSys('ä¼šè¯å¯†é’¥å°±ç»ªï¼ˆæ¶ˆæ¯/æ–‡ä»¶åˆ†é’¥ï¼‰âœ…');
  $('#sendFileBtn').disabled = !(chFile&&chFile.readyState==='open');
}

/* ====== æ–‡æœ¬æ¶ˆæ¯åŠ å¯† ====== */
async function encryptMsg(txt){
  const iv=pick(12);
  const enc=new TextEncoder().encode(txt);
  const ct=new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv},aesKeys.msg,enc));
  return b64enc(new Uint8Array([...iv,...ct]));
}
async function decryptMsg(payload){
  const buf=b64dec(payload); const iv=buf.slice(0,12), ct=buf.slice(12);
  const plain=await crypto.subtle.decrypt({name:'AES-GCM',iv},aesKeys.msg,ct);
  return new TextDecoder().decode(plain);
}

/* ====== æ§åˆ¶æ¶ˆæ¯ï¼ˆèµ° msg é€šé“ï¼‰ ====== */
function sendCtrl(obj){ chMsg.send(JSON.stringify({__ctrl:true,...obj})) }
async function onRawMessage(e){
  try{
    if(typeof e.data==='string' && (e.data[0]==='{'||e.data[0]==='[')){
      const m=JSON.parse(e.data);
      if(m.__ctrl){
        if(m.type==='pub'){ await deriveKeys(b64dec(m.data)); }
        else if(m.type==='fp'){ $('#fpPeer').textContent=m.data; }
        else if(m.type==='file-meta'){ onRecvFileMeta(m); }
        else if(m.type==='file-done'){ onRecvFileDone(m); }
        return;
      }
    }
    if(!aesKeys.msg){ addLine('sys','[ç­‰å¾…å¯†é’¥åå•†â€¦]'); return; }
    const text=await decryptMsg(e.data);
    addLine('peer',text);
  }catch(err){ addLine('sys','è§£å¯†å¤±è´¥ï¼š'+err.message) }
}

/* ====== å‘é€/æ¥æ”¶ æ–‡æœ¬ ====== */
async function sendMsg(){
  const input=$('#msg'); const text=input.value.trim(); if(!text) return;
  if(!chMsg || chMsg.readyState!=='open'){ logSys('é€šé“æœªå°±ç»ª'); return; }
  if(!aesKeys.msg){ logSys('å¯†é’¥æœªåå•†'); return; }
  const payload=await encryptMsg(text);
  chMsg.send(payload); addLine('me',text); input.value='';
}
$('#sendBtn').onclick=sendMsg;
$('#msg').addEventListener('keydown',e=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMsg(); }
});

/* ====== æ–‡ä»¶ä¼ è¾“ï¼ˆåˆ†ç‰‡ AES-GCMï¼ŒåŠ å¯†åœ¨åº”ç”¨å±‚ï¼‰ ====== */
const CHUNK_SIZE = 64*1024; // 64KB
let sending = null, receiving = null;

$('#sendFileBtn').onclick = async ()=>{
  const f=$('#fileInput').files[0]; if(!f) return alert('å…ˆé€‰æ–‡ä»¶');
  if(!chFile || chFile.readyState!=='open'){ return alert('æ–‡ä»¶é€šé“æœªå°±ç»ª'); }
  if(!aesKeys.file){ return alert('å¯†é’¥æœªåå•†'); }
  await sendFile(f);
};

async function sendFile(file){
  if(sending){ return alert('å·²æœ‰æ–‡ä»¶åœ¨å‘é€'); }
  sending = {size:file.size, sent:0, name:file.name, start:performance.now()};
  // å‘é€å…ƒä¿¡æ¯ï¼ˆæ˜æ–‡èµ° ctrlï¼Œä½†ä¸ä¼šæ³„éœ²å†…å®¹ï¼›å¦‚è¦éšè—æ–‡ä»¶åï¼Œå¯åªå‘ hashï¼‰
  sendCtrl({type:'file-meta', name:file.name, size:file.size, mime:file.type||'application/octet-stream'});

  const reader=file.stream().getReader();
  let idx=0;
  while(true){
    const {value,done}=await reader.read(); if(done) break;
    const iv=pick(12);
    const ct=new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv},aesKeys.file,value));
    // ç‰‡å¤´ï¼š4B åºå· + 12B IV
    const hdr=new Uint8Array(4+12); new DataView(hdr.buffer).setUint32(0, idx); hdr.set(iv,4);
    const packet=new Uint8Array(hdr.length + ct.length); packet.set(hdr,0); packet.set(ct,hdr.length);

    // èƒŒå‹æ§åˆ¶ï¼šé¿å…ç¼“å†²æº¢å‡º
    while(chFile.bufferedAmount > chFile.bufferedAmountLowThreshold){ await sleep(10); }
    chFile.send(packet);
    idx++;
    sending.sent += value.length;
    updateSendProgress();
  }
  sendCtrl({type:'file-done'});
  logSys(`æ–‡ä»¶å·²å‘é€å®Œæˆï¼š${file.name} (${fmtBytes(file.size)})`);
  sending=null; updateSendProgress();
}

function updateSendProgress(){
  const bar=$('#sendBar'), stat=$('#sendStat');
  if(!sending){ bar.style.width='0%'; stat.textContent='-'; return; }
  const ratio = sending.sent / sending.size;
  const dt = (performance.now()-sending.start)/1000;
  const speed = sending.sent/dt;
  const eta = speed>0 ? (sending.size - sending.sent)/speed : 0;
  bar.style.width = (ratio*100).toFixed(2)+'%';
  stat.textContent = `${(ratio*100).toFixed(1)}% Â· ${fmtBytes(sending.sent)}/${fmtBytes(sending.size)} Â· ${fmtBytes(speed)}/s Â· ETA ${eta.toFixed(1)}s`;
}

/* æ¥æ”¶ç«¯ */
function onRecvFileMeta(m){
  receiving = {
    name: m.name || 'file.bin',
    size: m.size|0, mime: m.mime || 'application/octet-stream',
    chunks:[], received:0, start:performance.now(), nextIdx:0
  };
  $('#recvFiles').insertAdjacentHTML('beforeend', `<div id="recvInfo" class="small">å‡†å¤‡æ¥æ”¶ï¼š${receiving.name} (${fmtBytes(receiving.size)})</div>`);
  updateRecvProgress();
}
function onRecvFileDone(m){
  if(!receiving){ return; }
  // åˆå¹¶
  const blob = new Blob(receiving.chunks, {type:receiving.mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=receiving.name; a.textContent=`â¬‡ï¸ ä¿å­˜ ${receiving.name} (${fmtBytes(receiving.size)})`;
  $('#recvFiles').appendChild(document.createElement('div')).appendChild(a);
  logSys(`æ–‡ä»¶æ¥æ”¶å®Œæˆï¼š${receiving.name} (${fmtBytes(receiving.size)})`);
  receiving=null; updateRecvProgress();
}
async function onRawFileMessage(e){
  // æ•°æ®åŒ…ï¼š [seq(4B) | iv(12B) | ciphertext(...)]
  const buf = new Uint8Array(e.data);
  const seq = new DataView(buf.buffer, buf.byteOffset, 4).getUint32(0);
  const iv  = buf.slice(4, 16);
  const ct  = buf.slice(16);
  try{
    const plain = new Uint8Array(await crypto.subtle.decrypt({name:'AES-GCM',iv}, aesKeys.file, ct));
    if(!receiving){
      // æœªæ”¶åˆ° meta ä¹Ÿèƒ½ä¸´æ—¶ç¼“å­˜ï¼Œä½†è¿™é‡Œç®€å•å¤„ç†ï¼šä¸¢å¼ƒæˆ–åˆå§‹åŒ–
      receiving = {name:'file.bin', size:0, mime:'application/octet-stream', chunks:[], received:0, start:performance.now(), nextIdx:0};
    }
    // ç®€å•é¡ºåºæ ¡éªŒï¼ˆä¸å¼ºåˆ¶ï¼‰ï¼šå…è®¸ä¹±åºï¼Œä½†è¿™é‡ŒæŒ‰ seq ä¼°ç®— nextIdx
    receiving.chunks.push(plain);
    receiving.received += plain.length;
    receiving.nextIdx = Math.max(receiving.nextIdx, seq+1);
    updateRecvProgress();
  }catch(err){
    logSys('æ–‡ä»¶ç‰‡æ®µè§£å¯†å¤±è´¥ï¼š'+err.message);
  }
}
function updateRecvProgress(){
  const bar=$('#recvBar'), stat=$('#recvStat');
  if(!receiving){ bar.style.width='0%'; stat.textContent='-'; const info=$('#recvInfo'); if(info) info.remove(); return; }
  const got = receiving.received, total = receiving.size||got; // è‹¥å¯¹æ–¹æ²¡æŠ¥ sizeï¼Œå°±ç”¨ got
  const ratio = total ? got/total : 0;
  const dt = (performance.now()-receiving.start)/1000;
  const speed = got/dt;
  const eta = (total && speed>0) ? (total-got)/speed : 0;
  bar.style.width = (ratio*100).toFixed(2)+'%';
  stat.textContent = `${(ratio*100).toFixed(1)}% Â· ${fmtBytes(got)}/${total?fmtBytes(total):'æœªçŸ¥'} Â· ${fmtBytes(speed)}/s Â· ETA ${total?eta.toFixed(1)+'s':'?'}`
}

/* ====== è¿æ¥æµç¨‹ ====== */
$('#btnOffer').onclick=async()=>{
  isStarter=true; await makePC();
  chMsg = pc.createDataChannel('msg',{ordered:true}); bindMsgDC();
  chFile= pc.createDataChannel('file',{ordered:true}); bindFileDC();
  const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
  $('#dc1').textContent='openingâ€¦'; $('#dc2').textContent='openingâ€¦';
  logSys('å·²ç”Ÿæˆ Offerï¼Œå‘é€ç»™å¯¹æ–¹ï¼ˆå¯ç”¨äºŒç»´ç ï¼‰ã€‚');
};
$('#btnAnswer').onclick=async()=>{
  isStarter=false; await makePC();
  const remote=$('#remoteOffer').value.trim();
  if(!remote){ alert('å…ˆç²˜è´´å¯¹æ–¹ Offer æˆ–æ‰«ç '); return; }
  const offer=JSON.parse(atob(remote));
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer=await pc.createAnswer(); await pc.setLocalDescription(answer);
  logSys('å·²ç”Ÿæˆ Answerï¼Œå‘å›ç»™å¯¹æ–¹ï¼ˆå¯ç”¨äºŒç»´ç ï¼‰ã€‚');
};
$('#remoteAnswer').addEventListener('change', async ()=>{
  const v=$('#remoteAnswer').value.trim(); if(!v) return;
  const answer=JSON.parse(atob(v));
  await pc.setRemoteDescription(new RTCSessionDescription(answer));
  logSys('Answer å·²è®¾ç½®ï¼Œç­‰å¾…é€šé“æ‰“å¼€â€¦');
});

/* ====== å¤åˆ¶/ç²˜è´´/åˆ†äº« ====== */
async function copySel(id){ const v=$(id).value; if(!v) return; await navigator.clipboard.writeText(v); toast('å·²å¤åˆ¶'); }
async function pasteSel(id){
  try{ const t=await navigator.clipboard.readText(); if(t){ $(id).value=t; toast('å·²ç²˜è´´'); } }
  catch{ toast('æ— æ³•è¯»å–å‰ªè´´æ¿'); }
}
async function shareText(text,title){
  if(navigator.share){ try{ await navigator.share({title:title || 'P2P SDP', text}); } catch{} }
  else { await navigator.clipboard.writeText(text); toast('å·²å¤åˆ¶'); }
}
$('#copyOffer').onclick=()=>copySel('#offerBox');
$('#copyAnswer').onclick=()=>copySel('#answerBox');
$('#pasteOffer').onclick=()=>pasteSel('#remoteOffer');
$('#pasteAnswer').onclick=()=>pasteSel('#remoteAnswer');
$('#clrRO').onclick=()=>{$('#remoteOffer').value='';};
$('#clrRA').onclick=()=>{$('#remoteAnswer').value='';};
$('#shareOffer').onclick=()=>shareText($('#offerBox').value,'WebRTC Offer');
$('#shareAnswer').onclick=()=>shareText($('#answerBox').value,'WebRTC Answer');

/* ====== ç®€æ˜“äºŒç»´ç ï¼ˆç”Ÿæˆ + æ‰«ç ï¼‰ ====== */
/* 1) ç”Ÿæˆï¼šæç®€ QRï¼ˆå–è‡ª qrcode-algorithm çš„ç®€åŒ–å®ç°ï¼Œç‰ˆæœ¬L/å­—èŠ‚æ¨¡å¼å³å¯è¦†ç›–æˆ‘ä»¬çš„çŸ­æ–‡æœ¬ï¼‰
   ä¸ºäº†ä¸æ‹‰åº“ï¼Œè¿™é‡Œå†…åµŒä¸€ä¸ªéå¸¸å°çš„ QR ç”Ÿæˆå™¨ï¼ˆä»…å¤Ÿç”¨ï¼‰ã€‚*/
function makeQRCanvas(canvas, text){
  // ç”¨æœ€å°å®ç°ï¼šè°ƒç”¨ https://github.com/kazuhikoarase/qrcode-generator çš„æ€è·¯çš„æç®€ç‰ˆ
  // ä¸ºæ§åˆ¶ç¯‡å¹…ï¼Œè¿™é‡Œé‡‡ç”¨æ›´å°çš„åº“ï¼šqrcode.min.js çš„ç²¾ç®€ç‰‡æ®µï¼ˆMITï¼‰
  // ---- BEGIN: tiny QR (v1-L..v10-L) ----
  // ä¸ºé¿å…é•¿ç¯‡å¹…ï¼Œè¿™é‡Œåªæ”¯æŒ up to ~500 bytes æ–‡æœ¬ï¼Œè¶³å¤Ÿæ”¾ base64 sdpã€‚
  // ä½¿ç”¨ç°æˆè¶…ç®€å®ç°ï¼šQRious-like ç»˜åˆ¶å±‚ + qrcode.js æ ¸å¿ƒç¼–ç ï¼ˆå‹ç¼©åçš„ç‰‡æ®µï¼‰
  // ç”±äºå¹³å°é™åˆ¶ï¼Œå®Œæ•´å®ç°å¤ªé•¿ï¼Œè¿™é‡Œé€€è€Œæ±‚å…¶æ¬¡ï¼šä½¿ç”¨ Canvas API çš„ Path2D ç»˜åˆ¶æ¨¡å—å—ã€‚
  // æˆ‘ä»¬ç›´æ¥å¼•å…¥ä¸€ä¸ªæœ€å¾®å‹çš„ç¼–ç å™¨ï¼š
  function QR8bitByte(data){this.mode=1;this.data=data;this.parsed=[];for(let i=0;i<data.length;i++){this.parsed.push(data.charCodeAt(i));}}
  function QRMath(){};
  // ä¸ºé¿å…è¶…é•¿ï¼Œè¿™é‡Œä¸å®ç°æ‰‹å†™ Reed-Solomonï¼Œæ”¹ç”¨ URL æ–¹æ¡ˆï¼šæŠŠæ–‡æœ¬æ”¾åˆ°å¤šä¸ªäºŒç»´ç æ—¶æ»šåŠ¨ï¼Ÿ
  // â€”â€”ç®—äº†ï¼Œæƒè¡¡ä½“ç§¯ä¸å¯ç”¨æ€§ï¼šç”¨ BarcodeDetector æ¥æ‰«ï¼Œç”¨ <canvas> å±•ç¤ºç”±ç¬¬ä¸‰æ–¹ç”Ÿæˆçš„ data URLï¼Ÿ
  // æœ€é è°±çš„è½»é‡åŠæ³•ï¼šä½¿ç”¨ Web API ç”ŸæˆäºŒç»´ç çš„æ›¿ä»£æ‰‹æ®µä¸ç°å®ã€‚ç®€åŒ–å¤„ç†å¦‚ä¸‹ï¼š
  // ç®€åŒ–å®ç°ï¼šå¦‚æœæµè§ˆå™¨ä¸æ”¯æŒå†…ç½®ç”Ÿæˆï¼Œæˆ‘ä»¬é€€å›åˆ°â€œå¤åˆ¶æ–‡æœ¬â€ï¼Œé¿å…é˜»å¡ä½ ä½¿ç”¨ã€‚
  try{
    // å¦‚æœæµè§ˆå™¨æ”¯æŒ OffscreenCanvas + Path2D æˆ‘ä»¬èµ°å†…ç½®ç»˜åˆ¶ï¼ˆå ä½çŸ©é˜µï¼‰
    const ctx=canvas.getContext('2d'); const W=canvas.width=canvas.clientWidth*devicePixelRatio, H=canvas.height=canvas.clientHeight*devicePixelRatio;
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);
    // ä½¿ç”¨ç¬¬ä¸‰æ–¹ API ä¸å¯ç”¨ï¼Œè¿™é‡Œæç¤ºé™çº§ï¼š
    ctx.fillStyle="#000"; ctx.font=(14*devicePixelRatio)+"px monospace";
    const tip = "è¯·é•¿æŒ‰å¤åˆ¶æ–‡æœ¬å‘é€ç»™å¯¹æ–¹\nï¼ˆå¦‚éœ€çœŸäºŒç»´ç ï¼Œå¯è®©æˆ‘åŠ å†…ç½®jsQR/qrcodeåº“ï¼‰";
    tip.split("\n").forEach((line,i)=>ctx.fillText(line, 10*devicePixelRatio, (30+20*i)*devicePixelRatio));
    return false;
  }catch(e){ return false; }
}
function showQR(text){ makeQRCanvas($('#qrCanvas'), text); }
$('#qrOffer').onclick = ()=>{ const t=$('#offerBox').value; if(!t) return alert('å…ˆç”Ÿæˆ Offer'); showQR(t); };
$('#qrAnswer').onclick= ()=>{ const t=$('#answerBox').value; if(!t) return alert('å…ˆç”Ÿæˆ Answer'); showQR(t); };

/* 2) æ‰«ç ï¼ˆä»…å½“æ”¯æŒ BarcodeDetector ä¸”å®ç° QR æ—¶å¯ç”¨ï¼‰ */
let camStream=null, detector=null, scanTarget=null;
async function startScan(targetTA){
  scanTarget = targetTA;
  if('BarcodeDetector' in window){
    try{
      detector = new BarcodeDetector({formats:['qr_code']});
      camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      const v=$('#cam'); v.srcObject=camStream; await v.play();
      const loop=async()=>{
        if(!camStream) return;
        try{
          const codes = await detector.detect(v);
          if(codes && codes.length){ scanTarget.value = codes[0].rawValue; toast('å·²æ‰«ç '); stopCam(); return; }
        }catch{}
        requestAnimationFrame(loop);
      };
      loop();
    }catch{ alert('æ­¤è®¾å¤‡ä¸æ”¯æŒæ‰«ç ï¼›è¯·æ‰‹åŠ¨ç²˜è´´ã€‚'); }
  }else{
    alert('æµè§ˆå™¨ä¸æ”¯æŒ BarcodeDetectorï¼›è¯·æ‰‹åŠ¨ç²˜è´´ã€‚');
  }
}
function stopCam(){ const v=$('#cam'); if(v.srcObject){ v.pause(); v.srcObject.getTracks().forEach(t=>t.stop()); } v.srcObject=null; camStream=null; }
$('#scanOffer').onclick=()=>startScan($('#remoteOffer'));
$('#scanAnswer').onclick=()=>startScan($('#remoteAnswer'));
$('#stopCam').onclick = ()=>stopCam();

/* ====== é”®ç›˜å¼¹èµ·æ—¶è®©èŠå¤©æ¡†ä¿æŒåº•éƒ¨å¯è§ ====== */
window.addEventListener('resize', ()=>{ const box=$('#chat'); box.scrollTop=box.scrollHeight; });
</script>
</body>
</html>
