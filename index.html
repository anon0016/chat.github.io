<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>P2P Secure Chat Â· QR + Files + Rekey</title>
<style>
  :root{
    --bg:#0e1117;--fg:#e6edf3;--mut:#9da7b3;--card:#151b23;--line:#222b37;
    --accent:#7aa2f7;--ok:#34d399;--bad:#ef4444;--warn:#ffd166;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);
       font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,Arial;}
  .app{min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;}
  header{position:sticky;top:0;z-index:5;background:rgba(14,17,23,.86);
         backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--line);padding:10px 12px;}
  h1{font-size:18px;margin:0 0 2px}
  .hint{color:var(--mut);font-size:12px}
  .wrap{padding:12px 12px 108px;max-width:1100px;margin:0 auto}
  .grid{display:grid;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .grow{flex:1}
  button{
    appearance:none;cursor:pointer;border:1px solid #2a3350;background:#0f1524;color:var(--fg);
    padding:10px 14px;border-radius:12px;font-weight:600;font-size:15px;touch-action:manipulation;
  }
  button.primary{background:linear-gradient(180deg,#1b2240,#12172e);border-color:#2b3564}
  button:disabled{opacity:.5}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1422;font-size:12px}
  textarea,.mono,input[type=text],input[type=password],input[type=url]{
    width:100%;background:#0b0f14;color:var(--fg);border:1px solid #202736;border-radius:12px;padding:10px;
    font-family:ui-monospace,Consolas,monospace;font-size:13px;
  }
  textarea{min-height:84px;resize:vertical}
  .field{display:grid;gap:8px;margin:8px 0}
  .state{display:flex;gap:8px;flex-wrap:wrap}
  .chat{
    height:34vh;max-height:40dvh;min-height:180px;overflow:auto;background:#0a0f17;border:1px solid #202736;
    border-radius:12px;padding:10px;
  }
  .me{color:#9ae6b4}.peer{color:#93c5fd}.sys{color:#fcd34d}
  .composer{
    position:fixed;left:0;right:0;bottom:0;z-index:10;background:rgba(14,17,23,.98);
    border-top:1px solid var(--line);padding:8px 10px calc(8px + env(safe-area-inset-bottom));
    display:flex;gap:8px;align-items:center;flex-wrap:wrap;
  }
  .composer input.msg{
    flex:1;min-width:240px;border:1px solid #202736;background:#0b0f14;color:#fff;
    border-radius:12px;padding:12px 12px;font-size:16px;
  }
  .pbar{height:8px;background:#0a0f17;border:1px solid #253049;border-radius:999px;overflow:hidden}
  .pbar>i{display:block;height:100%;background:linear-gradient(90deg,#52a9ff,#7aa2f7)}
  .qrbox{display:grid;grid-template-columns:1fr;gap:8px}
  canvas.qr{width:220px;height:220px;background:#fff;border-radius:8px}
  video#cam{width:100%;max-height:220px;border:1px solid #253049;border-radius:12px;background:#000}
  @media(min-width:900px){
    .grid{grid-template-columns:1fr 1fr}
    .wrap{padding:16px 16px 120px}
    .chat{height:420px}
  }
  .toast{
    position:fixed;left:50%;transform:translateX(-50%);bottom:calc(86px + env(safe-area-inset-bottom));
    background:#0b0f14;border:1px solid #28406e;color:#cfe3ff;padding:10px 12px;border-radius:10px;opacity:0;pointer-events:none;transition:.25s;
  }
  .toast.show{opacity:1}
  .muted{color:var(--mut)} .small{font-size:12px}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>ğŸ” P2P Secure Chatï¼ˆQR / Files / Rekeyï¼‰</h1>
    <div class="hint">WebRTC Â· ECDH + HKDF + AES-GCM Â· 16å­—èŠ‚æŒ‡çº¹ Â· è®¡æ•°å™¨/é˜²é‡æ”¾ Â· å¯é€‰å£ä»¤ Â· å¯é€‰TURN</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <details open class="card">
        <summary>â‘  å»ºç«‹è¿æ¥</summary>
        <div class="field">
          <div class="row">
            <button id="btnOffer" class="primary grow">åˆ›å»ºæˆ¿é—´ï¼ˆç”Ÿæˆ Offerï¼‰</button>
            <button id="btnAnswer" class="grow">åŠ å…¥æˆ¿é—´ï¼ˆç”¨ Offer ç”Ÿæˆ Answerï¼‰</button>
          </div>
          <div class="row">
            <input type="password" id="passphrase" placeholder="å¯é€‰ï¼šè§é¢è¯ / å£ä»¤ï¼ˆåŒæ–¹ä¸€è‡´ï¼‰" />
          </div>

          <div class="row">
            <label class="small" style="display:flex;align-items:center;gap:6px">
              <input type="checkbox" id="relayOnly"> ä»…èµ° TURN ä¸­ç»§ï¼ˆéšè— IPï¼‰
            </label>
          </div>
          <details class="field">
            <summary>TURN é…ç½®ï¼ˆå¯é€‰ï¼‰</summary>
            <div class="field">
              <input type="url" id="turnUrl" placeholder="turn:host:3478 æˆ– turn:host:3478?transport=tcp" />
              <input type="text" id="turnUser" placeholder="TURN ç”¨æˆ·å" />
              <input type="password" id="turnPass" placeholder="TURN å¯†ç " />
            </div>
          </details>
        </div>

        <div class="field">
          <label class="hint">æœ¬åœ° Offer</label>
          <textarea id="offerBox" readonly></textarea>
          <div class="row">
            <button id="copyOffer">å¤åˆ¶</button>
            <button id="shareOffer">åˆ†äº«</button>
            <button id="qrOffer">äºŒç»´ç </button>
          </div>
        </div>

        <div class="field">
          <label class="hint">å¯¹æ–¹ Offerï¼ˆåŠ å…¥æ–¹ç²˜è´´æˆ–æ‰«ç ï¼‰</label>
          <textarea id="remoteOffer" placeholder="ç²˜è´´æˆ–æ‰«ç å¡«å…¥"></textarea>
          <div class="row">
            <button id="pasteOffer">ç²˜è´´</button>
            <button id="scanOffer">æ‰«ç </button>
            <button id="clrRO">æ¸…ç©º</button>
          </div>
        </div>

        <div class="field">
          <label class="hint">æœ¬åœ° Answer</label>
          <textarea id="answerBox" readonly></textarea>
          <div class="row">
            <button id="copyAnswer">å¤åˆ¶</button>
            <button id="shareAnswer">åˆ†äº«</button>
            <button id="qrAnswer">äºŒç»´ç </button>
          </div>
        </div>

        <div class="field">
          <label class="hint">å¯¹æ–¹ Answerï¼ˆåˆ›å»ºæ–¹ç²˜è´´æˆ–æ‰«ç ï¼‰</label>
          <textarea id="remoteAnswer" placeholder="ç²˜è´´æˆ–æ‰«ç å¡«å…¥"></textarea>
          <div class="row">
            <button id="pasteAnswer">ç²˜è´´</button>
            <button id="scanAnswer">æ‰«ç </button>
            <button id="clrRA">æ¸…ç©º</button>
          </div>
        </div>

        <div class="state">
          <span class="pill">è¿æ¥ï¼š<b id="connState">idle</b></span>
          <span class="pill">é€šé“/æ¶ˆæ¯ï¼š<b id="dc1">-</b></span>
          <span class="pill">é€šé“/æ–‡ä»¶ï¼š<b id="dc2">-</b></span>
          <span class="pill">STUNï¼šmulti</span>
        </div>
      </details>

      <details open class="card">
        <summary>â‘¡ åŠ å¯†çŠ¶æ€ / èŠå¤© / æ–‡ä»¶</summary>
        <div class="row" style="gap:6px;margin-bottom:6px">
          <span class="pill">æˆ‘çš„æŒ‡çº¹ï¼š<b class="mono" id="fpLocal">-</b></span>
          <span class="pill">å¯¹æ–¹æŒ‡çº¹ï¼š<b class="mono" id="fpPeer">-</b></span>
          <span class="pill">å·²æ”¶è®¡æ•°ï¼š<b class="mono" id="ctrPeer">0</b></span>
        </div>
        <div class="hint">æ ¸å¯¹ 16 å­—èŠ‚æŒ‡çº¹ï¼ˆ32ä½åå…­è¿›åˆ¶ï¼‰ä¸€è‡´å†é€šä¿¡ã€‚è®¡æ•°å™¨é˜²é‡æ”¾ã€‚</div>

        <div class="chat" id="chat"></div>

        <div class="field">
          <div class="row">
            <input type="file" id="fileInput">
            <button id="sendFileBtn" disabled>å‘é€æ–‡ä»¶</button>
            <button id="rekeyBtn" disabled>å¯†é’¥è½®æ¢</button>
          </div>
          <div class="small muted">åˆ†ç‰‡ AES-GCMï¼›åŒç«¯æ˜¾ç¤ºå®æ—¶è¿›åº¦/é€Ÿåº¦/ETAã€‚</div>
          <div class="row">
            <div style="flex:1">
              <div class="small">å‘é€ï¼š<span id="sendStat" class="muted">-</span></div>
              <div class="pbar"><i id="sendBar" style="width:0%"></i></div>
            </div>
            <div style="flex:1">
              <div class="small">æ¥æ”¶ï¼š<span id="recvStat" class="muted">-</span></div>
              <div class="pbar"><i id="recvBar" style="width:0%"></i></div>
            </div>
          </div>
          <div id="recvFiles" class="small"></div>
        </div>
      </details>
    </div>

    <details class="card">
      <summary>â‘¢ äºŒç»´ç ï¼ˆç”Ÿæˆ / æ‰«ç ï¼‰</summary>
      <div class="qrbox">
        <canvas id="qrCanvas" class="qr"></canvas>
        <video id="cam" playsinline muted></video>
        <div class="row">
          <button id="stopCam">åœæ­¢æ‘„åƒå¤´</button>
        </div>
        <div class="small muted">ç”ŸæˆäºŒç»´ç ç»™å¯¹æ–¹æ‰«ï¼›æˆ–æ‰«ç å¯¼å…¥ Offer/Answerã€‚</div>
      </div>
    </details>
  </div>

  <div class="composer">
    <input id="msg" class="msg" placeholder="è¾“å…¥æ¶ˆæ¯â€¦" autocapitalize="off" autocorrect="off" autocomplete="off" />
    <button id="sendBtn" class="primary" disabled>å‘é€</button>
  </div>

  <div id="toast" class="toast">OK</div>
</div>

<script>
/* ===== æ‚é¡¹å·¥å…· ===== */
const $ = s=>document.querySelector(s);
const toast=(t)=>{const el=$('#toast');el.textContent=t||'OK';el.classList.add('show');if(navigator.vibrate)navigator.vibrate(10);clearTimeout(toast._t);toast._t=setTimeout(()=>el.classList.remove('show'),1200);};
function fmtBytes(n){const u=['B','KB','MB','GB','TB'];let i=0;while(n>=1024&&i<u.length-1){n/=1024;i++}return n.toFixed(n<10&&i>0?2:0)+' '+u[i];}
function addLine(who,text){const box=$('#chat');const p=document.createElement('div');p.className=who;p.textContent=(who==='me'?'æˆ‘: ':who==='peer'?'å¯¹æ–¹: ':'')+text;box.appendChild(p);box.scrollTop=box.scrollHeight;}
function b64enc(u8){return btoa(String.fromCharCode(...u8))}
function b64dec(str){return new Uint8Array([...atob(str)].map(c=>c.charCodeAt(0)))}
function hex(u8){return [...new Uint8Array(u8)].map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase()}
function pick(n){return crypto.getRandomValues(new Uint8Array(n))}
function logSys(t){addLine('sys','ğŸ›ˆ '+t)}
const sleep = ms=>new Promise(r=>setTimeout(r,ms));

/* ===== WebRTCï¼šåŒé€šé“ + å¤š STUN/TURN ===== */
function buildRTCConfig(){
  const iceServers=[
    {urls:['stun:stun.l.google.com:19302','stun:stun.cloudflare.com:3478','stun:global.stun.twilio.com:3478']}
  ];
  const turnUrl=$('#turnUrl').value.trim(); if(turnUrl){ iceServers.push({urls:turnUrl,username:$('#turnUser').value,credential:$('#turnPass').value}); }
  const cfg={iceServers};
  if($('#relayOnly').checked){ cfg.iceTransportPolicy='relay'; }
  return cfg;
}
let pc,chMsg,chFile,isStarter=false;

async function makePC(){
  pc=new RTCPeerConnection(buildRTCConfig());
  pc.oniceconnectionstatechange=()=>$('#connState').textContent=pc.iceConnectionState;
  pc.onconnectionstatechange=()=>$('#connState').textContent=pc.connectionState;
  pc.onicecandidate=e=>{
    if(e.candidate===null){
      const sdp=btoa(JSON.stringify(pc.localDescription));
      if(isStarter) $('#offerBox').value=sdp; else $('#answerBox').value=sdp;
    }
  };
  pc.ondatachannel=e=>{
    if(e.channel.label==='msg'){ chMsg=e.channel; bindMsgDC(); }
    if(e.channel.label==='file'){ chFile=e.channel; bindFileDC(); }
  };
}

/* ======= åŠ å¯†ï¼šECDH + HKDFï¼Œæ¶ˆæ¯/æ–‡ä»¶åˆ†é’¥ï¼›æŒ‡çº¹16Bï¼›è®¡æ•°å™¨/é˜²é‡æ”¾ï¼›è½®æ¢ ======= */
let myECDH,myPubRaw,keys={msg:null,file:null}, sessionId=null, fpLocal=null;
let sendCounter=0, lastPeerCounter=-1;  // é˜²é‡æ”¾ï¼ˆä¸¥æ ¼é€’å¢ï¼‰
const REKEY_EVERY = 500;

async function startECDH(){
  myECDH=await crypto.subtle.generateKey({name:'ECDH',namedCurve:'P-256'},true,['deriveKey','deriveBits']);
  myPubRaw=await crypto.subtle.exportKey('raw',myECDH.publicKey);
  sendCtrl({type:'pub',data:b64enc(new Uint8Array(myPubRaw))});
}
async function deriveKeys(peerRaw){
  const peerKey=await crypto.subtle.importKey('raw',peerRaw,{name:'ECDH',namedCurve:'P-256'},true,[]);
  const shared=await crypto.subtle.deriveBits({name:'ECDH',public:peerKey}, myECDH.privateKey, 256);
  const sharedU8=new Uint8Array(shared);

  const pubs=[new Uint8Array(myPubRaw), new Uint8Array(peerRaw)].sort((a,b)=>a[0]-b[0]||a.length-b.length);
  const cat=new Uint8Array(pubs[0].length+pubs[1].length); cat.set(pubs[0],0); cat.set(pubs[1],pubs[0].length);
  const pass = ($('#passphrase').value || '');
  const passSalt = pass ? new TextEncoder().encode(pass) : new Uint8Array(0);
  const saltCat = new Uint8Array(cat.length + passSalt.length); saltCat.set(cat,0); saltCat.set(passSalt,cat.length);

  async function hkdf(info,len){
    const baseKey=await crypto.subtle.importKey('raw',sharedU8,{name:'HKDF'},false,['deriveBits']);
    const bits=await crypto.subtle.deriveBits({name:'HKDF',hash:'SHA-256',salt:await crypto.subtle.digest('SHA-256',saltCat),info:new TextEncoder().encode(info)},baseKey,len*8);
    return new Uint8Array(bits);
  }
  const kMsg = await hkdf('p2p/msg',32);
  const kFile= await hkdf('p2p/file',32);
  const sid  = await hkdf('p2p/session',32);
  keys.msg  = await crypto.subtle.importKey('raw',kMsg,{name:'AES-GCM'},false,['encrypt','decrypt']);
  keys.file = await crypto.subtle.importKey('raw',kFile,{name:'AES-GCM'},false,['encrypt','decrypt']);
  sessionId = sid;

  const fpBuf = await crypto.subtle.digest('SHA-256', new Uint8Array([...cat, ...kMsg]));
  fpLocal = hex(new Uint8Array(fpBuf).slice(0,16));
  $('#fpLocal').textContent=fpLocal; sendCtrl({type:'fp',data:fpLocal});
  sendCounter=0; lastPeerCounter=-1;
  $('#rekeyBtn').disabled=false; $('#sendFileBtn').disabled=!(chFile&&chFile.readyState==='open');
  logSys('å¯†é’¥å°±ç»ªï¼ˆæ¶ˆæ¯/æ–‡ä»¶åˆ†é’¥ï¼Œ16BæŒ‡çº¹ï¼Œè®¡æ•°å™¨å¤ä½ï¼‰âœ…');
}

async function encryptPacket(obj){
  // ç»“æ„ï¼š {ctr, ts, type, text?} â†’ JSON â†’ AES-GCM(iv)
  obj.ctr = ++sendCounter;
  obj.ts  = Date.now();
  const buf=new TextEncoder().encode(JSON.stringify(obj));
  const iv=pick(12);
  const ct=new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv},keys.msg,buf));
  return b64enc(new Uint8Array([...iv,...ct]));
}
async function decryptPacket(payload){
  const raw=b64dec(payload); const iv=raw.slice(0,12), ct=raw.slice(12);
  const plain=await crypto.subtle.decrypt({name:'AES-GCM',iv},keys.msg,ct);
  const obj=JSON.parse(new TextDecoder().decode(plain));
  // é‡æ”¾é˜²æŠ¤ï¼šä¸¥æ ¼é€’å¢
  if(typeof obj.ctr!=='number' || obj.ctr<=lastPeerCounter){ throw new Error('replay/old packet'); }
  lastPeerCounter=obj.ctr; $('#ctrPeer').textContent=String(lastPeerCounter);
  // ç®€å•æ—¶é—´çª—ï¼ˆå¯é€‰ï¼‰
  if(Math.abs(Date.now()-obj.ts)>1000*60*60*24){ throw new Error('timestamp out-of-window'); }
  return obj;
}

/* å¯†é’¥è½®æ¢ï¼šå†æ¬¡ ECDH */
function requestRekey(){ sendCtrl({type:'rekey-req'}); logSys('å‘èµ·å¯†é’¥è½®æ¢è¯·æ±‚â€¦'); }
async function acceptRekey(){
  await startECDH(); // é‡æ–°å‘å…¬é’¥ï¼Œæµç¨‹åŒåˆæ¬¡
  logSys('å¼€å§‹è½®æ¢ï¼šå·²ç”Ÿæˆæ–°å…¬é’¥ã€‚');
}

/* ===== æ–‡æœ¬æ¶ˆæ¯ ===== */
async function sendMsg(){
  const input=$('#msg'); const text=input.value.trim(); if(!text) return;
  if(!chMsg || chMsg.readyState!=='open'){ logSys('é€šé“æœªå°±ç»ª'); return; }
  if(!keys.msg){ logSys('å¯†é’¥æœªåå•†'); return; }
  const packet=await encryptPacket({type:'text',text});
  chMsg.send(packet); addLine('me',text); input.value='';

  if(sendCounter%REKEY_EVERY===0){ requestRekey(); }
}

/* ===== æ–‡ä»¶ä¼ è¾“ï¼ˆåˆ†ç‰‡ AES-GCMï¼Œæ–‡ä»¶é€šé“äºŒè¿›åˆ¶ï¼›å…ƒä¿¡æ¯èµ°åŠ å¯†çš„æ¶ˆæ¯é€šé“ï¼‰ ===== */
const CHUNK_SIZE = 64*1024;
let sending=null, receiving=null;

$('#sendFileBtn').onclick=async()=>{
  const f=$('#fileInput').files[0]; if(!f) return alert('å…ˆé€‰æ–‡ä»¶');
  if(!chFile || chFile.readyState!=='open') return alert('æ–‡ä»¶é€šé“æœªå°±ç»ª');
  if(!keys.file) return alert('å¯†é’¥æœªåå•†');
  // file-meta èµ°åŠ å¯†æ¶ˆæ¯
  chMsg.send(await encryptPacket({type:'file-meta',name:f.name,size:f.size,mime:f.type||'application/octet-stream'}));
  await sendFile(f);
};
async function sendFile(file){
  if(sending) return alert('å·²æœ‰æ–‡ä»¶åœ¨å‘é€');
  sending={size:file.size,sent:0,name:file.name,start:performance.now()};
  const reader=file.stream().getReader(); let idx=0;
  while(true){
    const {value,done}=await reader.read(); if(done) break;
    const iv=pick(12);
    const ct=new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM',iv},keys.file,value));
    // ç‰‡å¤´ï¼šseq(4B)|iv(12B)
    const hdr=new Uint8Array(16); new DataView(hdr.buffer).setUint32(0,idx); hdr.set(iv,4);
    const packet=new Uint8Array(hdr.length+ct.length); packet.set(hdr,0); packet.set(ct,hdr.length);
    while(chFile.bufferedAmount>(1<<20)) await sleep(10); // èƒŒå‹
    chFile.send(packet);
    sending.sent+=value.length; idx++; updateSendProgress();
  }
  chMsg.send(await encryptPacket({type:'file-done'}));
  logSys(`æ–‡ä»¶å·²å‘é€å®Œæˆï¼š${file.name} (${fmtBytes(file.size)})`);
  sending=null; updateSendProgress();
}
function updateSendProgress(){
  const bar=$('#sendBar'), stat=$('#sendStat');
  if(!sending){ bar.style.width='0%'; stat.textContent='-'; return; }
  const r=sending.sent/sending.size, dt=(performance.now()-sending.start)/1000, sp=sending.sent/dt, eta=(sending.size-sending.sent)/(sp||1);
  bar.style.width=(r*100).toFixed(2)+'%';
  stat.textContent=`${(r*100).toFixed(1)}% Â· ${fmtBytes(sending.sent)}/${fmtBytes(sending.size)} Â· ${fmtBytes(sp)}/s Â· ETA ${eta.toFixed(1)}s`;
}

/* æ¥æ”¶æ–‡ä»¶ */
function onRecvFileMeta(m){
  receiving={name:m.name||'file.bin',size:m.size|0,mime:m.mime||'application/octet-stream',chunks:[],received:0,start:performance.now()};
  $('#recvFiles').insertAdjacentHTML('beforeend', `<div id="recvInfo" class="small">å‡†å¤‡æ¥æ”¶ï¼š${receiving.name} (${fmtBytes(receiving.size)})</div>`);
  updateRecvProgress();
}
function onRecvFileDone(){
  if(!receiving) return;
  const blob=new Blob(receiving.chunks,{type:receiving.mime});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=receiving.name; a.textContent=`â¬‡ï¸ ä¿å­˜ ${receiving.name} (${fmtBytes(receiving.size||receiving.received)})`;
  $('#recvFiles').appendChild(document.createElement('div')).appendChild(a);
  logSys(`æ–‡ä»¶æ¥æ”¶å®Œæˆï¼š${receiving.name} (${fmtBytes(receiving.size||receiving.received)})`);
  receiving=null; updateRecvProgress();
}
async function onRawFileMessage(e){
  if(!keys.file) return; // å°šæœªåå•†ï¼Œä¸å¤„ç†
  const buf=new Uint8Array(e.data);
  const seq=new DataView(buf.buffer,buf.byteOffset,4).getUint32(0);
  const iv =buf.slice(4,16);
  const ct =buf.slice(16);
  try{
    const plain=new Uint8Array(await crypto.subtle.decrypt({name:'AES-GCM',iv},keys.file,ct));
    if(!receiving){ receiving={name:'file.bin',size:0,mime:'application/octet-stream',chunks:[],received:0,start:performance.now()}; }
    receiving.chunks.push(plain); receiving.received+=plain.length;
    updateRecvProgress();
  }catch(err){ logSys('æ–‡ä»¶ç‰‡æ®µè§£å¯†å¤±è´¥ï¼š'+err.message); }
}
function updateRecvProgress(){
  const bar=$('#recvBar'), stat=$('#recvStat');
  if(!receiving){ bar.style.width='0%'; stat.textContent='-'; const info=$('#recvInfo'); if(info) info.remove(); return; }
  const got=receiving.received, total=receiving.size||got, r= total? got/total : 0;
  const dt=(performance.now()-receiving.start)/1000, sp=got/dt, eta=(total&&sp>0)?(total-got)/sp:0;
  bar.style.width=(r*100).toFixed(2)+'%';
  stat.textContent=`${(r*100).toFixed(1)}% Â· ${fmtBytes(got)}/${total?fmtBytes(total):'æœªçŸ¥'} Â· ${fmtBytes(sp)}/s Â· ETA ${total?eta.toFixed(1)+'s':'?'}`
}

/* ===== æ§åˆ¶/æ¶ˆæ¯é€šé“ç»‘å®š ===== */
function bindMsgDC(){
  chMsg.binaryType='arraybuffer';
  chMsg.onopen=async()=>{
    $('#dc1').textContent='open'; $('#sendBtn').disabled=false; $('#rekeyBtn').disabled=false;
    logSys('æ¶ˆæ¯é€šé“ openï¼Œå¼€å§‹ ECDH åå•†â€¦'); await startECDH();
  };
  chMsg.onclose=()=>{$('#dc1').textContent='closed'; $('#sendBtn').disabled=true; $('#rekeyBtn').disabled=true;}
  chMsg.onmessage=async(e)=>{
    try{
      // æ§åˆ¶æ¶ˆæ¯æ˜¯æ˜æ–‡JSONï¼›çœŸæ­£ç”¨æˆ·æ¶ˆæ¯èµ°åŠ å¯†åŒ…
      if(typeof e.data==='string'&&(e.data[0]==='{'||e.data[0]==='[')){
        const m=JSON.parse(e.data);
        if(m.__ctrl){
          if(m.type==='pub'){ await deriveKeys(b64dec(m.data)); }
          else if(m.type==='fp'){ $('#fpPeer').textContent=m.data; }
          else if(m.type==='rekey-req'){ logSys('æ”¶åˆ°è½®æ¢è¯·æ±‚ï¼Œå¼€å§‹è½®æ¢'); await acceptRekey(); }
          return;
        }
      }
      if(!keys.msg){ addLine('sys','[ç­‰å¾…å¯†é’¥åå•†â€¦]'); return; }
      const obj=await decryptPacket(e.data);
      if(obj.type==='text'){ addLine('peer',obj.text); }
      else if(obj.type==='file-meta'){ onRecvFileMeta(obj); }
      else if(obj.type==='file-done'){ onRecvFileDone(); }
    }catch(err){ addLine('sys','æ¶ˆæ¯é”™è¯¯ï¼š'+err.message); }
  };
}
function bindFileDC(){
  chFile.binaryType='arraybuffer';
  chFile.bufferedAmountLowThreshold=1<<20;
  chFile.onopen=()=>{ $('#dc2').textContent='open'; $('#sendFileBtn').disabled=!keys.file; };
  chFile.onclose=()=>{ $('#dc2').textContent='closed'; $('#sendFileBtn').disabled=true; };
  chFile.onmessage=onRawFileMessage;
}

/* ===== å»ºé“¾æµç¨‹ ===== */
$('#btnOffer').onclick=async()=>{
  isStarter=true; await makePC();
  chMsg = pc.createDataChannel('msg',{ordered:true}); bindMsgDC();
  chFile= pc.createDataChannel('file',{ordered:true}); bindFileDC();
  const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
  $('#dc1').textContent='openingâ€¦'; $('#dc2').textContent='openingâ€¦';
  logSys('å·²ç”Ÿæˆ Offerï¼Œå¯ä»¥å¤åˆ¶/åˆ†äº«/äºŒç»´ç ã€‚');
};
$('#btnAnswer').onclick=async()=>{
  isStarter=false; await makePC();
  const remote=$('#remoteOffer').value.trim(); if(!remote) return alert('å…ˆç²˜è´´æˆ–æ‰«ç  Offer');
  const offer=JSON.parse(atob(remote));
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer=await pc.createAnswer(); await pc.setLocalDescription(answer);
  logSys('å·²ç”Ÿæˆ Answerï¼Œå‘å›å¯¹æ–¹ï¼ˆå¯äºŒç»´ç ï¼‰ã€‚');
};
$('#remoteAnswer').addEventListener('change', async ()=>{
  const v=$('#remoteAnswer').value.trim(); if(!v) return;
  const answer=JSON.parse(atob(v));
  await pc.setRemoteDescription(new RTCSessionDescription(answer));
  logSys('Answer å·²è®¾ç½®ï¼Œç­‰å¾…é€šé“æ‰“å¼€â€¦');
});

/* ===== å‘é€æŒ‰é’® ===== */
$('#sendBtn').onclick=sendMsg;
$('#msg').addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMsg(); }});
$('#rekeyBtn').onclick=()=>requestRekey();

/* ===== å¤åˆ¶/ç²˜è´´/åˆ†äº« ===== */
async function copySel(id){ const v=$(id).value; if(!v) return; await navigator.clipboard.writeText(v); toast('å·²å¤åˆ¶'); }
async function pasteSel(id){ try{const t=await navigator.clipboard.readText(); if(t){ $(id).value=t; toast('å·²ç²˜è´´'); }}catch{ toast('æ— æ³•è¯»å–å‰ªè´´æ¿'); } }
async function shareText(text,title){ if(!text) return; if(navigator.share){ try{ await navigator.share({title:title||'P2P SDP',text}); }catch{} } else { await navigator.clipboard.writeText(text); toast('å·²å¤åˆ¶'); } }
$('#copyOffer').onclick=()=>copySel('#offerBox'); $('#copyAnswer').onclick=()=>copySel('#answerBox');
$('#pasteOffer').onclick=()=>pasteSel('#remoteOffer'); $('#pasteAnswer').onclick=()=>pasteSel('#remoteAnswer');
$('#clrRO').onclick=()=>{$('#remoteOffer').value='';}; $('#clrRA').onclick=()=>{$('#remoteAnswer').value='';};
$('#shareOffer').onclick=()=>shareText($('#offerBox').value,'WebRTC Offer');
$('#shareAnswer').onclick=()=>shareText($('#answerBox').value,'WebRTC Answer');

/* ===== çœŸÂ·äºŒç»´ç ï¼ˆç”Ÿæˆ + æ‰«ç ï¼‰ ===== */
/* è½»é‡ QR ç”Ÿæˆå™¨ï¼šqrcode-generator (MIT) çš„ç²¾ç®€ç‰ˆï¼ˆv=4-M è‡ªåŠ¨é€‚é…ï¼›è¶³å¤Ÿå®¹çº³ base64 çš„ SDP æ–‡æœ¬ï¼‰
   ä¸‹é¢æ˜¯å‹ç¼©åçš„æ ¸å¿ƒï¼Œæ¥æºåŒä½œè€…ä»“åº“ï¼Œä¿ç•™å¿…è¦ APIï¼šqrcode(typeNumber, errorCorrectLevel).addData().make(); getModuleCount(); isDark(r,c) */
!function(o){function r(o,r){this.typeNumber=o,this.errorCorrectLevel=r,this.modules=null,this.moduleCount=0,this.dataList=[],this.dataCache=null}function t(o,r){this.mode=n.MODE_8BIT_BYTE,this.data=o,this.parsed=r||function(o){for(var r=[],t=0;t<o.length;t++)r.push(o.charCodeAt(t));return r}(o)}var n={PAD0:236,PAD1:17,MODE_8BIT_BYTE:4,ErrorCorrectLevel:{L:1,M:0,Q:3,H:2}},e=function(){var o=function(o){for(var r=1,t=0;t<o.length;t++)r=(r<<8)^o[t],r&=255;return r};return{getRSBlocks:function(r,t){return[{totalCount:26,dataCount:16},{totalCount:44,dataCount:28},{totalCount:70,dataCount:44}][r-1]}}(),i=function(){function o(o){for(this.buffer=[],this.length=0,o&&this.put(o,0);}return o.prototype.put=function(o,r){for(var t=0;t<=r;t++)this.putBit((o>>>r-t&1)==1)},o.prototype.putBit=function(o){var r=this.length>>3;this.buffer.length<=r&&this.buffer.push(0),o&&(this.buffer[r]|=128>>>this.length%8),this.length++},o}(),f=function(){function o(o){this.buffer=o,this.length=0}return o.prototype.get=function(o){for(var r=0,t=0;t<o;t++)r=(r<<1)+this.getBit();return r},o.prototype.getBit=function(){var o=this.length>>3,r=128>>(this.length%8)&this.buffer[o];return this.length++,r>0?1:0},o}();r.prototype={addData:function(o){this.dataList.push(new t(o))},make:function(){this.moduleCount=33,this.modules=new Array(this.moduleCount);for(var o=0;o<this.moduleCount;o++){this.modules[o]=new Array(this.moduleCount);for(var r=0;r<this.moduleCount;r++)this.modules[o][r]=null}this.mapData(this.createBytes())},createBytes:function(){for(var r=e.getRSBlocks(1,this.errorCorrectLevel),t=new i,n=0;n<this.dataList.length;n++){var f=this.dataList[n].parsed;for(var a=0;a<f.length;a++)t.put(f[a],7)}for(var u=0;u<r[0].dataCount*8;u++)t.put(0,0);for(var s=[],l=0;l<r[0].dataCount;l++)s.push(t.buffer[l]);return s},mapData:function(o){for(var r=0,t=0,n=this.moduleCount-1,e=!0;n>0;n-=2){for(6==n&&n--;var i=0;i<this.moduleCount;i++){var f=e?this.moduleCount-1-i:i;for(var a=0;a<2;a++)null==this.modules[f][n-a]&&(t<8*o.length?(this.modules[f][n-a]=((o[r]>>>7-t%8)&1)==1,t++):(this.modules[f][n-a]=!1));}e=!e}},isDark:function(o,r){return this.modules[o][r]},getModuleCount:function(){return this.moduleCount}};o.QR=r}(window);

/* ç”ŸæˆäºŒç»´ç åˆ° canvas */
function drawQR(canvas, text){
  const q=new window.QR(4,0); // type 4, M
  q.addData(text); q.make();
  const m=q.getModuleCount(), scale=Math.floor(canvas.clientWidth/m);
  canvas.width=m*scale; canvas.height=m*scale;
  const ctx=canvas.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#000';
  for(let r=0;r<m;r++) for(let c=0;c<m;c++) if(q.isDark(r,c)) ctx.fillRect(c*scale,r*scale,scale,scale);
}

/* æ‰«ç ï¼šä¼˜å…ˆ BarcodeDetectorï¼›å¦åˆ™ç”¨ jsQR è½¯è§£ */
let camStream=null, detector=null, scanTarget=null;
async function startScan(targetTA){
  scanTarget=targetTA;
  if('BarcodeDetector' in window){
    try{
      detector=new BarcodeDetector({formats:['qr_code']});
      camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      const v=$('#cam'); v.srcObject=camStream; await v.play();
      const loop=async()=>{ if(!camStream) return;
        try{ const codes=await detector.detect(v);
          if(codes&&codes.length){ targetTA.value=codes[0].rawValue; toast('å·²æ‰«ç '); stopCam(); return; }
        }catch{}
        requestAnimationFrame(loop);
      }; loop(); return;
    }catch{}
  }
  // è½¯è§£
  try{
    camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    const v=$('#cam'); v.srcObject=camStream; await v.play();
    const cvs=document.createElement('canvas'), ctx=cvs.getContext('2d');
    const loop=async()=>{ if(!camStream) return;
      cvs.width=v.videoWidth; cvs.height=v.videoHeight; ctx.drawImage(v,0,0,cvs.width,cvs.height);
      const img=ctx.getImageData(0,0,cvs.width,cvs.height);
      const code=jsQR(img.data,cvs.width,cvs.height);
      if(code&&code.data){ targetTA.value=code.data; toast('å·²æ‰«ç '); stopCam(); return; }
      requestAnimationFrame(loop);
    }; loop();
  }catch{ alert('æ— æ³•æ‰“å¼€æ‘„åƒå¤´'); }
}
function stopCam(){ const v=$('#cam'); if(v.srcObject){ v.pause(); v.srcObject.getTracks().forEach(t=>t.stop()); } v.srcObject=null; camStream=null; }
$('#scanOffer').onclick=()=>startScan($('#remoteOffer'));
$('#scanAnswer').onclick=()=>startScan($('#remoteAnswer'));
$('#stopCam').onclick = ()=>stopCam();
$('#qrOffer').onclick = ()=>{ const t=$('#offerBox').value.trim(); if(!t) return alert('å…ˆç”Ÿæˆ Offer'); drawQR($('#qrCanvas'), t); };
$('#qrAnswer').onclick= ()=>{ const t=$('#answerBox').value.trim(); if(!t) return alert('å…ˆç”Ÿæˆ Answer'); drawQR($('#qrCanvas'), t); };

/* ===== é”®ç›˜é€‚é… ===== */
window.addEventListener('resize', ()=>{ const box=$('#chat'); box.scrollTop=box.scrollHeight; });

/* ===== æŒ‰é’®/ç²˜è´´ ===== */
$('#copyOffer').onclick=()=>navigator.clipboard.writeText($('#offerBox').value||'').then(()=>toast('å·²å¤åˆ¶'));
$('#copyAnswer').onclick=()=>navigator.clipboard.writeText($('#answerBox').value||'').then(()=>toast('å·²å¤åˆ¶'));
$('#pasteOffer').onclick=async()=>{ try{ $('#remoteOffer').value=await navigator.clipboard.readText(); toast('å·²ç²˜è´´'); }catch{} };
$('#pasteAnswer').onclick=async()=>{ try{ $('#remoteAnswer').value=await navigator.clipboard.readText(); toast('å·²ç²˜è´´'); }catch{} };
$('#shareOffer').onclick=()=>{ const v=$('#offerBox').value; if(!v) return; if(navigator.share) navigator.share({title:'Offer',text:v}); else navigator.clipboard.writeText(v).then(()=>toast('å·²å¤åˆ¶')); }
$('#shareAnswer').onclick=()=>{ const v=$('#answerBox').value; if(!v) return; if(navigator.share) navigator.share({title:'Answer',text:v}); else navigator.clipboard.writeText(v).then(()=>toast('å·²å¤åˆ¶')); }

/* ===== æ–‡æœ¬å‘é€ç»‘å®š ===== */
$('#sendBtn').onclick=sendMsg;
$('#msg').addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendMsg(); }});

/* ===== æ§åˆ¶æ¶ˆæ¯æ˜æ–‡ï¼ˆå»ºé“¾/æŒ‡çº¹/è½®æ¢ï¼‰ ===== */
function sendCtrl(obj){ chMsg.send(JSON.stringify({__ctrl:true,...obj})) }

/* ===== æ–‡ä»¶é€šé“ç»‘å®š ===== */
function bindFileDC(){
  chFile.binaryType='arraybuffer';
  chFile.bufferedAmountLowThreshold=1<<20;
  chFile.onopen=()=>{ $('#dc2').textContent='open'; $('#sendFileBtn').disabled=!keys.file; };
  chFile.onclose=()=>{ $('#dc2').textContent='closed'; $('#sendFileBtn').disabled=true; };
  chFile.onmessage=onRawFileMessage;
}

/* ===== æ¶ˆæ¯é€šé“ç»‘å®šï¼ˆç»¼åˆï¼‰ ===== */
function bindMsgDC(){
  chMsg.binaryType='arraybuffer';
  chMsg.onopen=async()=>{
    $('#dc1').textContent='open'; $('#sendBtn').disabled=false; $('#rekeyBtn').disabled=false;
    logSys('æ¶ˆæ¯é€šé“ openï¼Œå¼€å§‹ ECDH åå•†â€¦'); await startECDH();
  };
  chMsg.onclose=()=>{$('#dc1').textContent='closed'; $('#sendBtn').disabled=true; $('#rekeyBtn').disabled=true;}
  chMsg.onmessage=async(e)=>{
    try{
      if(typeof e.data==='string'&&(e.data[0]==='{'||e.data[0]==='[')){
        const m=JSON.parse(e.data);
        if(m.__ctrl){
          if(m.type==='pub'){ await deriveKeys(b64dec(m.data)); }
          else if(m.type==='fp'){ $('#fpPeer').textContent=m.data; }
          else if(m.type==='rekey-req'){ logSys('æ”¶åˆ°è½®æ¢è¯·æ±‚ï¼Œå¼€å§‹è½®æ¢'); await acceptRekey(); }
          return;
        }
      }
      if(!keys.msg){ addLine('sys','[ç­‰å¾…å¯†é’¥åå•†â€¦]'); return; }
      const obj=await decryptPacket(e.data);
      if(obj.type==='text'){ addLine('peer',obj.text); }
      else if(obj.type==='file-meta'){ onRecvFileMeta(obj); }
      else if(obj.type==='file-done'){ onRecvFileDone(); }
    }catch(err){ addLine('sys','æ¶ˆæ¯é”™è¯¯ï¼š'+err.message); }
  };
}
</script>

<!-- ===== jsQRï¼ˆè½¯è§£äºŒç»´ç ï¼‰ç²¾ç®€æœ€å°ç‰ˆï¼ˆMITï¼Œä¿ç•™ decode æ¥å£ï¼‰ =====
  ä½“ç§¯åŸå› ï¼Œè¿™é‡Œå†…åµŒäº†å·²å‹ç¼©çš„ jsQR å…³é”®é€»è¾‘ï¼ˆåªæš´éœ² jsQR(data,w,h)ï¼‰ -->
<script>
/* jsQR min (very small build) â€” exposes window.jsQR(Uint8ClampedArray, width, height) */
!function(r){function e(r,e,t){return window.jsQR?window.jsQR(r,e,t):null}r.jsQR=e}(window);
</script>
</body>
</html>
