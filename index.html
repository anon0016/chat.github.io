<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>P2P Minimal Connect · Files + QR</title>
<style>
  :root{--bg:#0e1117;--fg:#e6edf3;--mut:#9da7b3;--card:#151b23;--line:#222b37;--acc:#7aa2f7;--ok:#34d399;--bad:#ef4444}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,Arial}
  header{position:sticky;top:0;z-index:5;background:rgba(14,17,23,.9);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--line);padding:10px 12px}
  h1{margin:0 0 4px;font-size:18px}
  .hint{color:var(--mut);font-size:12px}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}
  .grid{display:grid;gap:12px}
  @media(min-width:1100px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1422;font-size:12px}
  textarea,input[type=text]{width:100%;background:#0b0f14;color:var(--fg);border:1px solid #202736;border-radius:12px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size:13px}
  button{appearance:none;cursor:pointer;border:1px solid #2a3350;background:#0f1524;color:var(--fg);padding:10px 14px;border-radius:12px;font-weight:600}
  button.primary{background:linear-gradient(180deg,#1b2240,#12172e);border-color:#2b3564}
  button:disabled{opacity:.5}
  .chat{height:260px;overflow:auto;background:#0a0f17;border:1px solid #202736;border-radius:12px;padding:10px}
  .me{color:#9ae6b4}.peer{color:#93c5fd}.sys{color:#fcd34d}
  .mono{font-family:ui-monospace,Consolas,monospace}
  .ok{color:var(--ok)}.bad{color:var(--bad)}
  .pbar{height:8px;background:#0a0f17;border:1px solid #253049;border-radius:999px;overflow:hidden}
  .pbar>i{display:block;height:100%;background:linear-gradient(90deg,#52a9ff,#7aa2f7);width:0%}
  .qr-grid{display:grid;gap:8px}
  .qr-grid img{width:220px;height:220px;border-radius:8px;background:#fff}
  video#cam{width:100%;max-height:220px;border:1px solid #253049;border-radius:12px;background:#000}
</style>
</head>
<body>
  <header>
    <h1>🔐 P2P Minimal Connect（+ 文件 + 二维码）</h1>
    <div class="hint">纯前端 · WebRTC · 先保证“创建/加入/聊天” + “文件传输” + “Offer/Answer 二维码”</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <section class="card">
        <h3>① 建立连接</h3>
        <div class="row">
          <button id="btnOffer" class="primary">创建房间（生成 Offer）</button>
          <button id="btnAnswer">加入房间（用 Offer 生成 Answer）</button>
        </div>
        <div class="row">
          <label class="pill">连接：<b id="connState">new</b></label>
          <label class="pill">通道/消息：<b id="dcState">-</b></label>
          <label class="pill">通道/文件：<b id="fileDcState">-</b></label>
          <label class="pill">ICE：<b id="iceState">new</b></label>
        </div>
        <div class="row" style="margin-top:4px">
          <label class="pill">STUN 多源</label>
          <label class="pill"><input type="checkbox" id="relayOnly"> 仅走TURN</label>
        </div>
        <details open>
          <summary>本地 Offer</summary>
          <textarea id="offerBox" readonly placeholder="点击“创建房间”后，这里会出现一长串 Base64"></textarea>
          <div class="row"><button id="copyOffer">复制</button> <button id="qrOffer">二维码</button></div>
        </details>
        <details>
          <summary>对方 Offer（加入方粘贴或扫码）</summary>
          <textarea id="remoteOffer" placeholder="粘贴对方给你的 Offer（Base64）"></textarea>
          <div class="row"><button id="scanOffer">扫码</button></div>
        </details>
        <details>
          <summary>本地 Answer</summary>
          <textarea id="answerBox" readonly placeholder="点击“加入房间”后，这里会出现一长串 Base64"></textarea>
          <div class="row"><button id="copyAnswer">复制</button> <button id="qrAnswer">二维码</button></div>
        </details>
        <details>
          <summary>对方 Answer（创建方粘贴或扫码）</summary>
          <textarea id="remoteAnswer" placeholder="粘贴对方给你的 Answer（Base64）"></textarea>
          <div class="row"><button id="scanAnswer">扫码</button></div>
        </details>
      </section>

      <section class="card">
        <h3>② 聊天 / 文件</h3>
        <div class="chat" id="log"></div>
        <div class="row" style="margin-top:8px">
          <input id="msg" type="text" placeholder="输入消息… 回车发送" disabled>
          <button id="btnSend" disabled>发送</button>
        </div>
        <div style="margin-top:10px">
          <div class="row">
            <input id="fileInput" type="file" />
            <button id="btnSendFile" disabled>发送文件</button>
          </div>
          <div class="row" style="margin-top:6px">
            <div style="flex:1">
              <div class="mono small">发送：<span id="sendStat">-</span></div>
              <div class="pbar"><i id="sendBar"></i></div>
            </div>
            <div style="flex:1">
              <div class="mono small">接收：<span id="recvStat">-</span></div>
              <div class="pbar"><i id="recvBar"></i></div>
            </div>
          </div>
          <div id="recvFiles" class="mono small" style="margin-top:6px"></div>
        </div>
      </section>
    </div>

    <section class="card">
      <h3>③ 二维码（生成 / 扫码）</h3>
      <div class="qr-grid">
        <img id="qrImg" alt="QR" />
        <video id="cam" playsinline muted></video>
        <div class="row"><button id="stopCam">停止摄像头</button></div>
        <div class="mono small" style="color:var(--mut)">生成二维码（使用公共 QR 图片 API）；扫码优先用 BarcodeDetector。</div>
      </div>
    </section>

    <section class="card">
      <h3>④ 自检（测试用例）</h3>
      <div id="tests" class="mono small"></div>
      <div class="row" style="margin-top:6px"><button id="runTests">运行测试</button></div>
    </section>
  </div>

<script>
'use strict';
// ========= 小工具 =========
const $=s=>document.querySelector(s);
const logBox=$('#log');
function logLine(cls, text){ const d=document.createElement('div'); d.className=cls; d.textContent=text; logBox.appendChild(d); logBox.scrollTop=logBox.scrollHeight; }
const info=t=>logLine('sys','🛈 '+t);
const mine=t=>logLine('me','我: '+t);
const peer=t=>logLine('peer','对方: '+t);
function b64e(obj){ return btoa(JSON.stringify(obj)); }
function b64d(b64){ return JSON.parse(atob(b64)); }
function fmtBytes(n){ const u=['B','KB','MB','GB','TB']; let i=0; while(n>=1024&&i<u.length-1){n/=1024;i++;} return n.toFixed(n<10&&i>0?2:0)+' '+u[i]; }

// ========= WebRTC =========
const iceServers=[{urls:['stun:stun.l.google.com:19302','stun:stun.cloudflare.com:3478','stun:global.stun.twilio.com:3478']}];
let pc, dcText, dcFile; let isHost=false;
function buildCfg(){ const cfg={iceServers:[...iceServers]}; if($('#relayOnly').checked) cfg.iceTransportPolicy='relay'; return cfg; }
async function newPC(){
  if(pc){ try{ pc.onicecandidate=null; pc.onconnectionstatechange=null; pc.close(); }catch(e){} }
  pc=new RTCPeerConnection(buildCfg());
  pc.onconnectionstatechange=()=>{ $('#connState').textContent=pc.connectionState; };
  pc.oniceconnectionstatechange=()=>{ $('#iceState').textContent=pc.iceConnectionState; };
  pc.ondatachannel=e=>{ if(e.channel.label==='chat'){ dcText=e.channel; bindTextDC(); } if(e.channel.label==='file'){ dcFile=e.channel; bindFileDC(); } };
  pc.onicecandidate=e=>{ if(e.candidate===null) fillLocalDesc(); };
}
function fillLocalDesc(){ if(!pc||!pc.localDescription) return; const v=b64e(pc.localDescription); if(isHost) $('#offerBox').value=v; else $('#answerBox').value=v; }

// ========= 数据通道：文本 =========
function bindTextDC(){
  $('#dcState').textContent=dcText.readyState;
  dcText.onopen=()=>{ $('#dcState').textContent='open'; $('#msg').disabled=false; $('#btnSend').disabled=false; info('文本通道 open'); };
  dcText.onclose=()=>{ $('#dcState').textContent='closed'; $('#msg').disabled=true; $('#btnSend').disabled=true; };
  dcText.onmessage=e=>peer(e.data);
}

// ========= 数据通道：文件（分片） =========
const CHUNK=64*1024; let sending=null, receiving=null;
function bindFileDC(){
  $('#fileDcState').textContent=dcFile.readyState;
  dcFile.binaryType='arraybuffer';
  dcFile.bufferedAmountLowThreshold=1<<20;
  dcFile.onopen=()=>{ $('#fileDcState').textContent='open'; $('#btnSendFile').disabled=false; info('文件通道 open'); };
  dcFile.onclose=()=>{ $('#fileDcState').textContent='closed'; $('#btnSendFile').disabled=true; };
  dcFile.onmessage=onFileChunk;
}

$('#btnSendFile').onclick=async()=>{
  const f=$('#fileInput').files[0]; if(!f){ alert('先选文件'); return; }
  if(!dcFile || dcFile.readyState!=='open'){ alert('文件通道未打开'); return; }
  await sendFile(f);
};

async function sendFile(file){
  if(sending){ alert('已有任务在发送'); return; }
  sending={name:file.name,size:file.size,sent:0,start:performance.now()};
  // 先发一个 JSON 头包（文本通道通知）
  if(dcText && dcText.readyState==='open'){ dcText.send('[FILE-META]'+JSON.stringify({name:file.name,size:file.size,type:file.type||'application/octet-stream'})); }
  const reader=file.stream().getReader(); let idx=0;
  while(true){
    const {value,done}=await reader.read(); if(done) break;
    // 包格式： seq(uint32) + payload
    const hdr=new Uint8Array(4); new DataView(hdr.buffer).setUint32(0,idx);
    const pkt=new Uint8Array(hdr.length+value.length); pkt.set(hdr,0); pkt.set(value,hdr.length);
    while(dcFile.bufferedAmount>(1<<20)) await new Promise(r=>setTimeout(r,10));
    dcFile.send(pkt);
    sending.sent+=value.length; idx++; updateSendProgress();
  }
  // 收尾包： seq = 0xFFFFFFFF
  const end=new Uint8Array(4); new DataView(end.buffer).setUint32(0,0xFFFFFFFF);
  dcFile.send(end);
}

function updateSendProgress(){
  const r=sending.sent/sending.size; $('#sendBar').style.width=(r*100).toFixed(2)+'%';
  const dt=(performance.now()-sending.start)/1000; const sp=sending.sent/dt; const eta=(sending.size-sending.sent)/(sp||1);
  $('#sendStat').textContent=`${(r*100).toFixed(1)}% · ${fmtBytes(sending.sent)}/${fmtBytes(sending.size)} · ${fmtBytes(sp)}/s · ETA ${eta.toFixed(1)}s`;
  if(sending.sent>=sending.size){ $('#sendStat').textContent+= ' · 待对方完成重组'; }
}

function onFileChunk(e){
  const buf=new Uint8Array(e.data);
  if(buf.length===4 && new DataView(buf.buffer).getUint32(0)===0xFFFFFFFF){
    // 完成
    if(!receiving) return;
    const blob=new Blob(receiving.parts,{type:receiving.type});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=receiving.name; a.textContent=`⬇️ 保存 ${receiving.name} (${fmtBytes(receiving.total)})`;
    $('#recvFiles').appendChild(document.createElement('div')).appendChild(a);
    receiving=null; $('#recvBar').style.width='0%'; $('#recvStat').textContent='-';
    return;
  }
  const seq=new DataView(buf.buffer,buf.byteOffset,4).getUint32(0);
  const payload=buf.slice(4);
  if(!receiving){ receiving={name:'file.bin',type:'application/octet-stream',total:0,parts:[],start:performance.now()}; }
  receiving.parts.push(payload); receiving.total+=payload.length; updateRecvProgress();
}

function updateRecvProgress(){
  const got=receiving.total; const dt=(performance.now()-receiving.start)/1000; const sp=got/dt;
  $('#recvBar').style.width='100%'; // 无对端总大小，这里不显示百分比，直到 meta 到来
  $('#recvStat').textContent=`${fmtBytes(got)} · ${fmtBytes(sp||0)}/s`;
}

// 文本通道收到文件元信息时，更新 UI
function onTextMessage(s){
  if(s.startsWith('[FILE-META]')){
    try{ const meta=JSON.parse(s.slice(11)); if(!receiving) receiving={name:meta.name||'file.bin',type:meta.type||'application/octet-stream',total:0,parts:[],start:performance.now()}; else { receiving.name=meta.name||receiving.name; receiving.type=meta.type||receiving.type; } info(`准备接收文件：${receiving.name} (${fmtBytes(meta.size||0)})`); }catch{}
    return;
  }
  peer(s);
}

// ========= 按钮逻辑 =========
$('#btnOffer').onclick=async()=>{
  try{
    isHost=true; await newPC();
    dcText=pc.createDataChannel('chat',{ordered:true}); bindTextDC();
    dcFile=pc.createDataChannel('file',{ordered:true}); bindFileDC();
    const offer=await pc.createOffer({offerToReceiveAudio:false,offerToReceiveVideo:false});
    await pc.setLocalDescription(offer);
    info('Offer 已创建，等 1-3 秒待 ICE 收敛后会自动出现在“本地 Offer”。');
  }catch(err){ info('创建 Offer 失败：'+err.message); }
};

$('#btnAnswer').onclick=async()=>{
  try{
    isHost=false; await newPC();
    const remote=$('#remoteOffer').value.trim(); if(!remote){ alert('先粘贴对方 Offer (Base64)'); return; }
    const offer=b64d(remote);
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer=await pc.createAnswer(); await pc.setLocalDescription(answer);
    info('Answer 已创建，等 1-3 秒后会自动出现在“本地 Answer”。');
  }catch(err){ info('加入失败：'+err.message); }
};

$('#remoteAnswer').addEventListener('change', async ()=>{
  try{
    const v=$('#remoteAnswer').value.trim(); if(!v) return;
    const ans=b64d(v);
    await pc.setRemoteDescription(new RTCSessionDescription(ans));
    info('已设置对方 Answer，等待通道打开…');
  }catch(err){ info('设置 Answer 失败：'+err.message); }
});

// 绑定文本 onmessage（复用 onTextMessage）
function bindTextDC(){
  $('#dcState').textContent=dcText.readyState;
  dcText.onopen=()=>{ $('#dcState').textContent='open'; $('#msg').disabled=false; $('#btnSend').disabled=false; info('文本通道 open'); };
  dcText.onclose=()=>{ $('#dcState').textContent='closed'; $('#msg').disabled=true; $('#btnSend').disabled=true; };
  dcText.onmessage=e=>onTextMessage(String(e.data));
}

// ========= 聊天 =========
$('#btnSend').onclick=()=>sendMsg();
$('#msg').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendMsg(); } });
function sendMsg(){ const t=$('#msg').value.trim(); if(!t||!dcText||dcText.readyState!=='open') return; dcText.send(t); mine(t); $('#msg').value=''; }

// ========= 复制 =========
$('#copyOffer').onclick=()=>{ const v=$('#offerBox').value; if(v) navigator.clipboard.writeText(v); };
$('#copyAnswer').onclick=()=>{ const v=$('#answerBox').value; if(v) navigator.clipboard.writeText(v); };

// ========= 二维码 =========
function setQR(text){ const img=$('#qrImg'); if(!text){ img.removeAttribute('src'); return; } img.src='https://api.qrserver.com/v1/create-qr-code/?size=220x220&data='+encodeURIComponent(text); }
$('#qrOffer').onclick=()=>{ const t=$('#offerBox').value.trim(); if(!t){ alert('先生成 Offer'); return; } setQR(t); };
$('#qrAnswer').onclick=()=>{ const t=$('#answerBox').value.trim(); if(!t){ alert('先生成 Answer'); return; } setQR(t); };
let camStream=null, detector=null;
async function startScan(targetTA){
  if('BarcodeDetector' in window){
    try{
      detector=new BarcodeDetector({formats:['qr_code']});
      camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      const v=$('#cam'); v.srcObject=camStream; await v.play();
      const loop=async()=>{ if(!camStream) return; try{ const codes=await detector.detect(v); if(codes&&codes.length){ targetTA.value=codes[0].rawValue; stopCam(); return; } }catch{} requestAnimationFrame(loop); };
      loop(); return;
    }catch{ alert('此设备不支持扫码；请手动粘贴。'); }
  }else{ alert('浏览器不支持 BarcodeDetector；请手动粘贴。'); }
}
function stopCam(){ const v=$('#cam'); if(v.srcObject){ v.pause(); v.srcObject.getTracks().forEach(t=>t.stop()); } v.srcObject=null; camStream=null; }
$('#scanOffer').onclick=()=>startScan($('#remoteOffer'));
$('#scanAnswer').onclick=()=>startScan($('#remoteAnswer'));
$('#stopCam').onclick=()=>stopCam();

// ========= 自检（测试用例） =========
$('#runTests').onclick=runTests;
async function runTests(){
  const out=[]; const ok=s=>`<span class="ok">✅</span> ${s}`; const bad=(s,e)=>`<span class="bad">❌</span> ${s} · ${e}`;
  try{ out.push(ok('脚本解析正常')); }catch(e){ out.push(bad('脚本解析', e.message)); }
  try{ out.push(typeof RTCPeerConnection==='function'?ok('WebRTC 可用'):bad('WebRTC 可用','RTCPeerConnection 缺失')); }catch(e){ out.push(bad('WebRTC 可用', e.message)); }
  try{ const probe={type:'offer',sdp:'x'}; const b64=btoa(JSON.stringify(probe)); const back=JSON.parse(atob(b64)); out.push(back.type==='offer'?ok('SDP Base64 回环'):bad('SDP Base64 回环','不等')); }catch(e){ out.push(bad('SDP Base64 回环', e.message)); }
  try{ out.push((typeof sendFile==='function' && typeof onFileChunk==='function')?ok('文件函数存在'):bad('文件函数存在','缺失')); }catch(e){ out.push(bad('文件函数存在', e.message)); }
  try{ out.push((typeof setQR==='function')?ok('二维码函数存在'):bad('二维码函数存在','缺失')); }catch(e){ out.push(bad('二维码函数存在', e.message)); }
  document.getElementById('tests').innerHTML=out.join('<br>');
}
</script>
</body>
</html>
