<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>P2P Minimal Connect Â· Files + QR</title>
<style>
  :root{--bg:#0e1117;--fg:#e6edf3;--mut:#9da7b3;--card:#151b23;--line:#222b37;--acc:#7aa2f7;--ok:#34d399;--bad:#ef4444}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,Arial}
  header{position:sticky;top:0;z-index:5;background:rgba(14,17,23,.9);backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid var(--line);padding:10px 12px}
  h1{margin:0 0 4px;font-size:18px}
  .hint{color:var(--mut);font-size:12px}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}
  .grid{display:grid;gap:12px}
  @media(min-width:1100px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1422;font-size:12px}
  textarea,input[type=text]{width:100%;background:#0b0f14;color:var(--fg);border:1px solid #202736;border-radius:12px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size:13px}
  button{appearance:none;cursor:pointer;border:1px solid #2a3350;background:#0f1524;color:var(--fg);padding:10px 14px;border-radius:12px;font-weight:600}
  button.primary{background:linear-gradient(180deg,#1b2240,#12172e);border-color:#2b3564}
  button:disabled{opacity:.5}
  .chat{height:260px;overflow:auto;background:#0a0f17;border:1px solid #202736;border-radius:12px;padding:10px}
  .me{color:#9ae6b4}.peer{color:#93c5fd}.sys{color:#fcd34d}
  .mono{font-family:ui-monospace,Consolas,monospace}
  .ok{color:var(--ok)}.bad{color:var(--bad)}
  .pbar{height:8px;background:#0a0f17;border:1px solid #253049;border-radius:999px;overflow:hidden}
  .pbar>i{display:block;height:100%;background:linear-gradient(90deg,#52a9ff,#7aa2f7);width:0%}
  .qr-grid{display:grid;gap:8px}
  .qr-grid img{width:220px;height:220px;border-radius:8px;background:#fff}
  video#cam{width:100%;max-height:220px;border:1px solid #253049;border-radius:12px;background:#000}
</style>
</head>
<body>
  <header>
    <h1>ğŸ” P2P Minimal Connectï¼ˆ+ æ–‡ä»¶ + äºŒç»´ç ï¼‰</h1>
    <div class="hint">çº¯å‰ç«¯ Â· WebRTC Â· å…ˆä¿è¯â€œåˆ›å»º/åŠ å…¥/èŠå¤©â€ + â€œæ–‡ä»¶ä¼ è¾“â€ + â€œOffer/Answer äºŒç»´ç â€</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <section class="card">
        <h3>â‘  å»ºç«‹è¿æ¥</h3>
        <div class="row">
          <button id="btnOffer" class="primary">åˆ›å»ºæˆ¿é—´ï¼ˆç”Ÿæˆ Offerï¼‰</button>
          <button id="btnAnswer">åŠ å…¥æˆ¿é—´ï¼ˆç”¨ Offer ç”Ÿæˆ Answerï¼‰</button>
        </div>
        <div class="row">
          <label class="pill">è¿æ¥ï¼š<b id="connState">new</b></label>
          <label class="pill">é€šé“/æ¶ˆæ¯ï¼š<b id="dcState">-</b></label>
          <label class="pill">é€šé“/æ–‡ä»¶ï¼š<b id="fileDcState">-</b></label>
          <label class="pill">ICEï¼š<b id="iceState">new</b></label>
        </div>
        <div class="row" style="margin-top:4px">
          <label class="pill">STUN å¤šæº</label>
          <label class="pill"><input type="checkbox" id="relayOnly"> ä»…èµ°TURN</label>
        </div>
        <details open>
          <summary>æœ¬åœ° Offer</summary>
          <textarea id="offerBox" readonly placeholder="ç‚¹å‡»â€œåˆ›å»ºæˆ¿é—´â€åï¼Œè¿™é‡Œä¼šå‡ºç°ä¸€é•¿ä¸² Base64"></textarea>
          <div class="row"><button id="copyOffer">å¤åˆ¶</button> <button id="qrOffer">äºŒç»´ç </button></div>
        </details>
        <details>
          <summary>å¯¹æ–¹ Offerï¼ˆåŠ å…¥æ–¹ç²˜è´´æˆ–æ‰«ç ï¼‰</summary>
          <textarea id="remoteOffer" placeholder="ç²˜è´´å¯¹æ–¹ç»™ä½ çš„ Offerï¼ˆBase64ï¼‰"></textarea>
          <div class="row"><button id="scanOffer">æ‰«ç </button></div>
        </details>
        <details>
          <summary>æœ¬åœ° Answer</summary>
          <textarea id="answerBox" readonly placeholder="ç‚¹å‡»â€œåŠ å…¥æˆ¿é—´â€åï¼Œè¿™é‡Œä¼šå‡ºç°ä¸€é•¿ä¸² Base64"></textarea>
          <div class="row"><button id="copyAnswer">å¤åˆ¶</button> <button id="qrAnswer">äºŒç»´ç </button></div>
        </details>
        <details>
          <summary>å¯¹æ–¹ Answerï¼ˆåˆ›å»ºæ–¹ç²˜è´´æˆ–æ‰«ç ï¼‰</summary>
          <textarea id="remoteAnswer" placeholder="ç²˜è´´å¯¹æ–¹ç»™ä½ çš„ Answerï¼ˆBase64ï¼‰"></textarea>
          <div class="row"><button id="scanAnswer">æ‰«ç </button></div>
        </details>
      </section>

      <section class="card">
        <h3>â‘¡ èŠå¤© / æ–‡ä»¶</h3>
        <div class="chat" id="log"></div>
        <div class="row" style="margin-top:8px">
          <input id="msg" type="text" placeholder="è¾“å…¥æ¶ˆæ¯â€¦ å›è½¦å‘é€" disabled>
          <button id="btnSend" disabled>å‘é€</button>
        </div>
        <div style="margin-top:10px">
          <div class="row">
            <input id="fileInput" type="file" />
            <button id="btnSendFile" disabled>å‘é€æ–‡ä»¶</button>
          </div>
          <div class="row" style="margin-top:6px">
            <div style="flex:1">
              <div class="mono small">å‘é€ï¼š<span id="sendStat">-</span></div>
              <div class="pbar"><i id="sendBar"></i></div>
            </div>
            <div style="flex:1">
              <div class="mono small">æ¥æ”¶ï¼š<span id="recvStat">-</span></div>
              <div class="pbar"><i id="recvBar"></i></div>
            </div>
          </div>
          <div id="recvFiles" class="mono small" style="margin-top:6px"></div>
        </div>
      </section>
    </div>

    <section class="card">
      <h3>â‘¢ äºŒç»´ç ï¼ˆç”Ÿæˆ / æ‰«ç ï¼‰</h3>
      <div class="qr-grid">
        <img id="qrImg" alt="QR" />
        <video id="cam" playsinline muted></video>
        <div class="row"><button id="stopCam">åœæ­¢æ‘„åƒå¤´</button></div>
        <div class="mono small" style="color:var(--mut)">ç”ŸæˆäºŒç»´ç ï¼ˆä½¿ç”¨å…¬å…± QR å›¾ç‰‡ APIï¼‰ï¼›æ‰«ç ä¼˜å…ˆç”¨ BarcodeDetectorã€‚</div>
      </div>
    </section>

    <section class="card">
      <h3>â‘£ è‡ªæ£€ï¼ˆæµ‹è¯•ç”¨ä¾‹ï¼‰</h3>
      <div id="tests" class="mono small"></div>
      <div class="row" style="margin-top:6px"><button id="runTests">è¿è¡Œæµ‹è¯•</button></div>
    </section>
  </div>

<script>
'use strict';
// ========= å°å·¥å…· =========
const $=s=>document.querySelector(s);
const logBox=$('#log');
function logLine(cls, text){ const d=document.createElement('div'); d.className=cls; d.textContent=text; logBox.appendChild(d); logBox.scrollTop=logBox.scrollHeight; }
const info=t=>logLine('sys','ğŸ›ˆ '+t);
const mine=t=>logLine('me','æˆ‘: '+t);
const peer=t=>logLine('peer','å¯¹æ–¹: '+t);
function b64e(obj){ return btoa(JSON.stringify(obj)); }
function b64d(b64){ return JSON.parse(atob(b64)); }
function fmtBytes(n){ const u=['B','KB','MB','GB','TB']; let i=0; while(n>=1024&&i<u.length-1){n/=1024;i++;} return n.toFixed(n<10&&i>0?2:0)+' '+u[i]; }

// ========= WebRTC =========
const iceServers=[{urls:['stun:stun.l.google.com:19302','stun:stun.cloudflare.com:3478','stun:global.stun.twilio.com:3478']}];
let pc, dcText, dcFile; let isHost=false;
function buildCfg(){ const cfg={iceServers:[...iceServers]}; if($('#relayOnly').checked) cfg.iceTransportPolicy='relay'; return cfg; }
async function newPC(){
  if(pc){ try{ pc.onicecandidate=null; pc.onconnectionstatechange=null; pc.close(); }catch(e){} }
  pc=new RTCPeerConnection(buildCfg());
  pc.onconnectionstatechange=()=>{ $('#connState').textContent=pc.connectionState; };
  pc.oniceconnectionstatechange=()=>{ $('#iceState').textContent=pc.iceConnectionState; };
  pc.ondatachannel=e=>{ if(e.channel.label==='chat'){ dcText=e.channel; bindTextDC(); } if(e.channel.label==='file'){ dcFile=e.channel; bindFileDC(); } };
  pc.onicecandidate=e=>{ if(e.candidate===null) fillLocalDesc(); };
}
function fillLocalDesc(){ if(!pc||!pc.localDescription) return; const v=b64e(pc.localDescription); if(isHost) $('#offerBox').value=v; else $('#answerBox').value=v; }

// ========= æ•°æ®é€šé“ï¼šæ–‡æœ¬ =========
function bindTextDC(){
  $('#dcState').textContent=dcText.readyState;
  dcText.onopen=()=>{ $('#dcState').textContent='open'; $('#msg').disabled=false; $('#btnSend').disabled=false; info('æ–‡æœ¬é€šé“ open'); };
  dcText.onclose=()=>{ $('#dcState').textContent='closed'; $('#msg').disabled=true; $('#btnSend').disabled=true; };
  dcText.onmessage=e=>peer(e.data);
}

// ========= æ•°æ®é€šé“ï¼šæ–‡ä»¶ï¼ˆåˆ†ç‰‡ï¼‰ =========
const CHUNK=64*1024; let sending=null, receiving=null;
function bindFileDC(){
  $('#fileDcState').textContent=dcFile.readyState;
  dcFile.binaryType='arraybuffer';
  dcFile.bufferedAmountLowThreshold=1<<20;
  dcFile.onopen=()=>{ $('#fileDcState').textContent='open'; $('#btnSendFile').disabled=false; info('æ–‡ä»¶é€šé“ open'); };
  dcFile.onclose=()=>{ $('#fileDcState').textContent='closed'; $('#btnSendFile').disabled=true; };
  dcFile.onmessage=onFileChunk;
}

$('#btnSendFile').onclick=async()=>{
  const f=$('#fileInput').files[0]; if(!f){ alert('å…ˆé€‰æ–‡ä»¶'); return; }
  if(!dcFile || dcFile.readyState!=='open'){ alert('æ–‡ä»¶é€šé“æœªæ‰“å¼€'); return; }
  await sendFile(f);
};

async function sendFile(file){
  if(sending){ alert('å·²æœ‰ä»»åŠ¡åœ¨å‘é€'); return; }
  sending={name:file.name,size:file.size,sent:0,start:performance.now()};
  // å…ˆå‘ä¸€ä¸ª JSON å¤´åŒ…ï¼ˆæ–‡æœ¬é€šé“é€šçŸ¥ï¼‰
  if(dcText && dcText.readyState==='open'){ dcText.send('[FILE-META]'+JSON.stringify({name:file.name,size:file.size,type:file.type||'application/octet-stream'})); }
  const reader=file.stream().getReader(); let idx=0;
  while(true){
    const {value,done}=await reader.read(); if(done) break;
    // åŒ…æ ¼å¼ï¼š seq(uint32) + payload
    const hdr=new Uint8Array(4); new DataView(hdr.buffer).setUint32(0,idx);
    const pkt=new Uint8Array(hdr.length+value.length); pkt.set(hdr,0); pkt.set(value,hdr.length);
    while(dcFile.bufferedAmount>(1<<20)) await new Promise(r=>setTimeout(r,10));
    dcFile.send(pkt);
    sending.sent+=value.length; idx++; updateSendProgress();
  }
  // æ”¶å°¾åŒ…ï¼š seq = 0xFFFFFFFF
  const end=new Uint8Array(4); new DataView(end.buffer).setUint32(0,0xFFFFFFFF);
  dcFile.send(end);
}

function updateSendProgress(){
  const r=sending.sent/sending.size; $('#sendBar').style.width=(r*100).toFixed(2)+'%';
  const dt=(performance.now()-sending.start)/1000; const sp=sending.sent/dt; const eta=(sending.size-sending.sent)/(sp||1);
  $('#sendStat').textContent=`${(r*100).toFixed(1)}% Â· ${fmtBytes(sending.sent)}/${fmtBytes(sending.size)} Â· ${fmtBytes(sp)}/s Â· ETA ${eta.toFixed(1)}s`;
  if(sending.sent>=sending.size){ $('#sendStat').textContent+= ' Â· å¾…å¯¹æ–¹å®Œæˆé‡ç»„'; }
}

function onFileChunk(e){
  const buf=new Uint8Array(e.data);
  if(buf.length===4 && new DataView(buf.buffer).getUint32(0)===0xFFFFFFFF){
    // å®Œæˆ
    if(!receiving) return;
    const blob=new Blob(receiving.parts,{type:receiving.type});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=receiving.name; a.textContent=`â¬‡ï¸ ä¿å­˜ ${receiving.name} (${fmtBytes(receiving.total)})`;
    $('#recvFiles').appendChild(document.createElement('div')).appendChild(a);
    receiving=null; $('#recvBar').style.width='0%'; $('#recvStat').textContent='-';
    return;
  }
  const seq=new DataView(buf.buffer,buf.byteOffset,4).getUint32(0);
  const payload=buf.slice(4);
  if(!receiving){ receiving={name:'file.bin',type:'application/octet-stream',total:0,parts:[],start:performance.now()}; }
  receiving.parts.push(payload); receiving.total+=payload.length; updateRecvProgress();
}

function updateRecvProgress(){
  const got=receiving.total; const dt=(performance.now()-receiving.start)/1000; const sp=got/dt;
  $('#recvBar').style.width='100%'; // æ— å¯¹ç«¯æ€»å¤§å°ï¼Œè¿™é‡Œä¸æ˜¾ç¤ºç™¾åˆ†æ¯”ï¼Œç›´åˆ° meta åˆ°æ¥
  $('#recvStat').textContent=`${fmtBytes(got)} Â· ${fmtBytes(sp||0)}/s`;
}

// æ–‡æœ¬é€šé“æ”¶åˆ°æ–‡ä»¶å…ƒä¿¡æ¯æ—¶ï¼Œæ›´æ–° UI
function onTextMessage(s){
  if(s.startsWith('[FILE-META]')){
    try{ const meta=JSON.parse(s.slice(11)); if(!receiving) receiving={name:meta.name||'file.bin',type:meta.type||'application/octet-stream',total:0,parts:[],start:performance.now()}; else { receiving.name=meta.name||receiving.name; receiving.type=meta.type||receiving.type; } info(`å‡†å¤‡æ¥æ”¶æ–‡ä»¶ï¼š${receiving.name} (${fmtBytes(meta.size||0)})`); }catch{}
    return;
  }
  peer(s);
}

// ========= æŒ‰é’®é€»è¾‘ =========
$('#btnOffer').onclick=async()=>{
  try{
    isHost=true; await newPC();
    dcText=pc.createDataChannel('chat',{ordered:true}); bindTextDC();
    dcFile=pc.createDataChannel('file',{ordered:true}); bindFileDC();
    const offer=await pc.createOffer({offerToReceiveAudio:false,offerToReceiveVideo:false});
    await pc.setLocalDescription(offer);
    info('Offer å·²åˆ›å»ºï¼Œç­‰ 1-3 ç§’å¾… ICE æ”¶æ•›åä¼šè‡ªåŠ¨å‡ºç°åœ¨â€œæœ¬åœ° Offerâ€ã€‚');
  }catch(err){ info('åˆ›å»º Offer å¤±è´¥ï¼š'+err.message); }
};

$('#btnAnswer').onclick=async()=>{
  try{
    isHost=false; await newPC();
    const remote=$('#remoteOffer').value.trim(); if(!remote){ alert('å…ˆç²˜è´´å¯¹æ–¹ Offer (Base64)'); return; }
    const offer=b64d(remote);
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer=await pc.createAnswer(); await pc.setLocalDescription(answer);
    info('Answer å·²åˆ›å»ºï¼Œç­‰ 1-3 ç§’åä¼šè‡ªåŠ¨å‡ºç°åœ¨â€œæœ¬åœ° Answerâ€ã€‚');
  }catch(err){ info('åŠ å…¥å¤±è´¥ï¼š'+err.message); }
};

$('#remoteAnswer').addEventListener('change', async ()=>{
  try{
    const v=$('#remoteAnswer').value.trim(); if(!v) return;
    const ans=b64d(v);
    await pc.setRemoteDescription(new RTCSessionDescription(ans));
    info('å·²è®¾ç½®å¯¹æ–¹ Answerï¼Œç­‰å¾…é€šé“æ‰“å¼€â€¦');
  }catch(err){ info('è®¾ç½® Answer å¤±è´¥ï¼š'+err.message); }
});

// ç»‘å®šæ–‡æœ¬ onmessageï¼ˆå¤ç”¨ onTextMessageï¼‰
function bindTextDC(){
  $('#dcState').textContent=dcText.readyState;
  dcText.onopen=()=>{ $('#dcState').textContent='open'; $('#msg').disabled=false; $('#btnSend').disabled=false; info('æ–‡æœ¬é€šé“ open'); };
  dcText.onclose=()=>{ $('#dcState').textContent='closed'; $('#msg').disabled=true; $('#btnSend').disabled=true; };
  dcText.onmessage=e=>onTextMessage(String(e.data));
}

// ========= èŠå¤© =========
$('#btnSend').onclick=()=>sendMsg();
$('#msg').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendMsg(); } });
function sendMsg(){ const t=$('#msg').value.trim(); if(!t||!dcText||dcText.readyState!=='open') return; dcText.send(t); mine(t); $('#msg').value=''; }

// ========= å¤åˆ¶ =========
$('#copyOffer').onclick=()=>{ const v=$('#offerBox').value; if(v) navigator.clipboard.writeText(v); };
$('#copyAnswer').onclick=()=>{ const v=$('#answerBox').value; if(v) navigator.clipboard.writeText(v); };

// ========= äºŒç»´ç  =========
function setQR(text){ const img=$('#qrImg'); if(!text){ img.removeAttribute('src'); return; } img.src='https://api.qrserver.com/v1/create-qr-code/?size=220x220&data='+encodeURIComponent(text); }
$('#qrOffer').onclick=()=>{ const t=$('#offerBox').value.trim(); if(!t){ alert('å…ˆç”Ÿæˆ Offer'); return; } setQR(t); };
$('#qrAnswer').onclick=()=>{ const t=$('#answerBox').value.trim(); if(!t){ alert('å…ˆç”Ÿæˆ Answer'); return; } setQR(t); };
let camStream=null, detector=null;
async function startScan(targetTA){
  if('BarcodeDetector' in window){
    try{
      detector=new BarcodeDetector({formats:['qr_code']});
      camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      const v=$('#cam'); v.srcObject=camStream; await v.play();
      const loop=async()=>{ if(!camStream) return; try{ const codes=await detector.detect(v); if(codes&&codes.length){ targetTA.value=codes[0].rawValue; stopCam(); return; } }catch{} requestAnimationFrame(loop); };
      loop(); return;
    }catch{ alert('æ­¤è®¾å¤‡ä¸æ”¯æŒæ‰«ç ï¼›è¯·æ‰‹åŠ¨ç²˜è´´ã€‚'); }
  }else{ alert('æµè§ˆå™¨ä¸æ”¯æŒ BarcodeDetectorï¼›è¯·æ‰‹åŠ¨ç²˜è´´ã€‚'); }
}
function stopCam(){ const v=$('#cam'); if(v.srcObject){ v.pause(); v.srcObject.getTracks().forEach(t=>t.stop()); } v.srcObject=null; camStream=null; }
$('#scanOffer').onclick=()=>startScan($('#remoteOffer'));
$('#scanAnswer').onclick=()=>startScan($('#remoteAnswer'));
$('#stopCam').onclick=()=>stopCam();

// ========= è‡ªæ£€ï¼ˆæµ‹è¯•ç”¨ä¾‹ï¼‰ =========
$('#runTests').onclick=runTests;
async function runTests(){
  const out=[]; const ok=s=>`<span class="ok">âœ…</span> ${s}`; const bad=(s,e)=>`<span class="bad">âŒ</span> ${s} Â· ${e}`;
  try{ out.push(ok('è„šæœ¬è§£ææ­£å¸¸')); }catch(e){ out.push(bad('è„šæœ¬è§£æ', e.message)); }
  try{ out.push(typeof RTCPeerConnection==='function'?ok('WebRTC å¯ç”¨'):bad('WebRTC å¯ç”¨','RTCPeerConnection ç¼ºå¤±')); }catch(e){ out.push(bad('WebRTC å¯ç”¨', e.message)); }
  try{ const probe={type:'offer',sdp:'x'}; const b64=btoa(JSON.stringify(probe)); const back=JSON.parse(atob(b64)); out.push(back.type==='offer'?ok('SDP Base64 å›ç¯'):bad('SDP Base64 å›ç¯','ä¸ç­‰')); }catch(e){ out.push(bad('SDP Base64 å›ç¯', e.message)); }
  try{ out.push((typeof sendFile==='function' && typeof onFileChunk==='function')?ok('æ–‡ä»¶å‡½æ•°å­˜åœ¨'):bad('æ–‡ä»¶å‡½æ•°å­˜åœ¨','ç¼ºå¤±')); }catch(e){ out.push(bad('æ–‡ä»¶å‡½æ•°å­˜åœ¨', e.message)); }
  try{ out.push((typeof setQR==='function')?ok('äºŒç»´ç å‡½æ•°å­˜åœ¨'):bad('äºŒç»´ç å‡½æ•°å­˜åœ¨','ç¼ºå¤±')); }catch(e){ out.push(bad('äºŒç»´ç å‡½æ•°å­˜åœ¨', e.message)); }
  document.getElementById('tests').innerHTML=out.join('<br>');
}
</script>
</body>
</html>
