<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>åŒ¿åèŠå¤©</title>
<style>
  :root{--bg:#0e1117;--fg:#e6edf3;--mut:#9da7b3;--card:#151b23;--line:#222b37;--accent:#7aa2f7;--ok:#34d399;--bad:#ef4444}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
  h1{font-size:18px;margin:14px 0}
  .wrap{max-width:1100px;margin:0 auto;padding:14px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  textarea,input[type=text]{width:100%;background:#0b0f14;color:var(--fg);border:1px solid #202736;border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace}
  textarea{min-height:120px;resize:vertical}
  button{cursor:pointer;border:1px solid #2a3350;background:#0f1524;color:var(--fg);padding:9px 12px;border-radius:10px;font-weight:600}
  button.primary{background:linear-gradient(180deg,#1b2240,#12172e);border-color:#2b3564}
  button:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1422;color:#c9d2df;font-size:12px}
  .chat{height:280px;overflow:auto;background:#0a0f17;border:1px solid #202736;border-radius:12px;padding:10px}
  .me{color:#9ae6b4}.peer{color:#93c5fd}.sys{color:#fcd34d}
  .hint{color:var(--mut);font-size:12px}
  .mono{font-family:ui-monospace,Consolas,monospace}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ” P2P åŠ å¯†èŠå¤©ï¼ˆWebRTC + ECDH + AES-GCMï¼‰</h1>
  <div class="hint">ä¸¤æ­¥èµ°ï¼šâ‘  å»ºç«‹è¿æ¥ï¼ˆå¤åˆ¶ Offer/Answerï¼‰â‘¡ æ ¸å¯¹æŒ‡çº¹ â†’ å¼€èŠã€‚æ•°æ®ä»…åœ¨ä¸¤ç«¯æµè§ˆå™¨å†…åŠ å¯†/è§£å¯†ã€‚</div>

  <div class="grid">
    <div class="card">
      <h3>1) å»ºç«‹è¿æ¥</h3>
      <div class="row">
        <button id="btnOffer" class="primary">åˆ›å»ºæˆ¿é—´ï¼ˆç”Ÿæˆ Offerï¼‰</button>
        <button id="btnAnswer">åŠ å…¥æˆ¿é—´ï¼ˆç”¨ Offer ç”Ÿæˆ Answerï¼‰</button>
      </div>
      <p class="hint">ä»»æ„ä¸€æ–¹éƒ½å¯å‘èµ·ã€‚æŠŠ Offer ç²˜ç»™å¯¹æ–¹ï¼›å¯¹æ–¹ç”Ÿæˆ Answer ç²˜å›ã€‚</p>
      <label class="hint">æœ¬åœ° Offerï¼š</label>
      <textarea id="offerBox" placeholder="ç‚¹å‡»â€œåˆ›å»ºæˆ¿é—´â€åç”Ÿæˆ"></textarea>
      <div class="row">
        <button id="copyOffer">å¤åˆ¶ Offer</button>
      </div>
      <label class="hint">å¯¹æ–¹çš„ Offerï¼ˆä»…åŠ å…¥æ–¹éœ€è¦ç²˜è´´åœ¨è¿™é‡Œï¼‰ï¼š</label>
      <textarea id="remoteOffer" placeholder="ç²˜è´´å¯¹æ–¹çš„ Offerï¼Œç„¶åç‚¹â€œåŠ å…¥æˆ¿é—´â€"></textarea>

      <label class="hint">æœ¬åœ° Answerï¼š</label>
      <textarea id="answerBox" placeholder="åŠ å…¥æ–¹ç”Ÿæˆåï¼Œå‘ç»™åˆ›å»ºæ–¹"></textarea>
      <div class="row">
        <button id="copyAnswer">å¤åˆ¶ Answer</button>
      </div>
      <label class="hint">å¯¹æ–¹çš„ Answerï¼ˆä»…åˆ›å»ºæ–¹éœ€è¦ç²˜è´´åœ¨è¿™é‡Œï¼‰ï¼š</label>
      <textarea id="remoteAnswer" placeholder="ç²˜è´´å¯¹æ–¹çš„ Answer å®Œæˆè¿æ¥"></textarea>

      <div class="row" style="margin-top:8px">
        <span class="pill">è¿æ¥ï¼š<b id="connState">idle</b></span>
        <span class="pill">é€šé“ï¼š<b id="dcState">-</b></span>
      </div>
      <div class="hint">ä½¿ç”¨ Google STUNï¼šstun.l.google.com:19302ï¼ˆå¯æ”¹è‡ªå»º STUN/TURNï¼‰</div>
    </div>

    <div class="card">
      <h3>2) ç«¯åˆ°ç«¯åŠ å¯†</h3>
      <div class="hint">è¿ä¸Šåä¼šè‡ªåŠ¨è¿›è¡Œ ECDH å¯†é’¥äº¤æ¢ï¼ˆP-256ï¼‰ï¼Œæ´¾ç”Ÿ 256 ä½ AES-GCM ä¼šè¯å¯†é’¥ã€‚</div>
      <div class="row" style="margin:6px 0">
        <span class="pill">æˆ‘çš„æŒ‡çº¹ï¼š<b class="mono" id="fpLocal">-</b></span>
        <span class="pill">å¯¹æ–¹æŒ‡çº¹ï¼š<b class="mono" id="fpPeer">-</b></span>
      </div>
      <div class="hint">è¯·ç”¨å…¶ä»–æ¸ é“æ ¸å¯¹ä¸¤è¾¹æ˜¾ç¤ºçš„**åŒä¸€ä¸²** 12 ä½åå…­è¿›åˆ¶æŒ‡çº¹ï¼ˆ6å­—èŠ‚ï¼‰ã€‚ä¸€è‡´â†’é˜²ä¸­é—´äººã€‚</div>

      <div class="chat" id="chat"></div>
      <div class="row" style="margin-top:8px">
        <input type="text" id="msg" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œå›è½¦å‘é€â€¦">
        <button id="sendBtn" class="primary" disabled>å‘é€</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== å°å·¥å…· ====== */
const $ = sel => document.querySelector(sel);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function logSys(t){ addLine('sys', 'ğŸ›ˆ '+t) }
function addLine(who, text){
  const box = $('#chat'); const p=document.createElement('div');
  p.className=who; p.textContent = (who==='me'?'æˆ‘: ': who==='peer'?'å¯¹æ–¹: ':'') + text;
  box.appendChild(p); box.scrollTop = box.scrollHeight;
}
function b64enc(u8){return btoa(String.fromCharCode(...u8))}
function b64dec(str){return new Uint8Array([...atob(str)].map(c=>c.charCodeAt(0)))}
function hex(ab){return [...new Uint8Array(ab)].map(b=>b.toString(16).padStart(2,'0')).join('')}
function pick(n){return crypto.getRandomValues(new Uint8Array(n))}

/* ====== WebRTC å‡†å¤‡ ====== */
const cfg = { iceServers:[{urls:"stun:stun.l.google.com:19302"}] };
let pc, dc, isStarter=false;

async function makePC(){
  pc = new RTCPeerConnection(cfg);
  pc.oniceconnectionstatechange = ()=> $('#connState').textContent = pc.iceConnectionState;
  pc.onconnectionstatechange = ()=> $('#connState').textContent = pc.connectionState;
  pc.onicecandidate = e=>{
    // trickle: æ–‡æœ¬é‡Œç›´æ¥æ›´æ–°
    if(e.candidate===null){
      if(isStarter) $('#offerBox').value = btoa(JSON.stringify(pc.localDescription));
      else $('#answerBox').value = btoa(JSON.stringify(pc.localDescription));
    }
  };
  pc.ondatachannel = e=>{
    dc = e.channel; bindDC();
  };
}

function bindDC(){
  dc.binaryType = 'arraybuffer';
  dc.onopen = async ()=>{
    $('#dcState').textContent = 'open';
    $('#sendBtn').disabled=false;
    logSys('DataChannel å·²æ‰“å¼€ï¼Œå¼€å§‹å¯†é’¥åå•†â€¦');
    await startECDH();
  };
  dc.onclose = ()=>{$('#dcState').textContent='closed'; $('#sendBtn').disabled=true;}
  dc.onmessage = onRawMessage;
}

/* ====== åº”ç”¨å±‚åŠ å¯†ï¼šECDH(P-256) + AES-GCM ====== */
let myECDH, myPubRaw, aesKey=null, bothFP=null;

async function startECDH(){
  // 1) ç”Ÿæˆæœ¬åœ° ECDH
  myECDH = await crypto.subtle.generateKey(
    {name:'ECDH', namedCurve:'P-256'}, true, ['deriveKey','deriveBits']
  );
  myPubRaw = await crypto.subtle.exportKey('raw', myECDH.publicKey); // 65å­—èŠ‚
  // 2) å‘ç»™å¯¹æ–¹
  sendControl({type:'pub', data: b64enc(new Uint8Array(myPubRaw))});
  // 3) ç­‰å¾…å¯¹æ–¹å…¬é’¥ â†’ derive
}

async function deriveAES(peerRaw){
  const peerKey = await crypto.subtle.importKey(
    'raw', peerRaw, {name:'ECDH', namedCurve:'P-256'}, true, []
  );
  aesKey = await crypto.subtle.deriveKey(
    {name:'ECDH', public:peerKey}, myECDH.privateKey,
    {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']
  );
  // æŒ‡çº¹ï¼šåŒæ–¹ raw pub æ’åºæ‹¼æ¥å SHA-256 â†’ å–å‰ 6 å­—èŠ‚
  const pubs = [new Uint8Array(myPubRaw), new Uint8Array(peerRaw)].sort((a,b)=>a[0]-b[0]||a.length-b.length);
  const concat = new Uint8Array(pubs[0].length+pubs[1].length); concat.set(pubs[0],0); concat.set(pubs[1],pubs[0].length);
  const digest = await crypto.subtle.digest('SHA-256', concat);
  const fp = hex(digest).slice(0,12).toUpperCase();
  bothFP = fp;
  $('#fpLocal').textContent = fp;
  sendControl({type:'fp', data:fp});
  logSys('ä¼šè¯å¯†é’¥å°±ç»ª âœ…ï¼Œå·²è¿›å…¥åŠ å¯†èŠå¤©ã€‚'); 
}

async function encryptText(txt){
  const iv = pick(12);
  const enc = new TextEncoder().encode(txt);
  const ct = new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM', iv}, aesKey, enc));
  // å‘é€ï¼šiv|ct â†’ base64
  const payload = b64enc(new Uint8Array([...iv, ...ct]));
  return payload;
}
async function decryptText(payload){
  const buf = b64dec(payload);
  const iv = buf.slice(0,12), ct = buf.slice(12);
  const plain = await crypto.subtle.decrypt({name:'AES-GCM', iv}, aesKey, ct);
  return new TextDecoder().decode(plain);
}

/* ====== æ§åˆ¶ä¿¡ä»¤ï¼ˆèµ° DataChannel å†…éƒ¨ï¼‰ ====== */
function sendControl(obj){
  dc.send(JSON.stringify({__ctrl:true, ...obj}));
}
async function onRawMessage(e){
  try{
    // å¯èƒ½æ˜¯æ§åˆ¶ï¼Œä¹Ÿå¯èƒ½æ˜¯å¯†æ–‡
    if(typeof e.data === 'string'){
      const first = e.data[0];
      if(first==='{' || first==='['){
        const msg = JSON.parse(e.data);
        if(msg.__ctrl){
          if(msg.type==='pub'){ // æ”¶åˆ°å¯¹æ–¹å…¬é’¥
            await deriveAES(b64dec(msg.data));
          }else if(msg.type==='fp'){
            $('#fpPeer').textContent = msg.data;
          }
          return;
        }
      }
      // æ™®é€šå­—ç¬¦ä¸²ï¼šåŠ å¯†è´Ÿè½½
      if(!aesKey){ addLine('peer','[ç­‰å¾…å¯†é’¥åå•†â€¦]'); return; }
      const text = await decryptText(e.data);
      addLine('peer', text);
    }else{
      addLine('sys','[æ”¶åˆ°æœªçŸ¥äºŒè¿›åˆ¶æ•°æ®]');
    }
  }catch(err){ addLine('sys','è§£å¯†å¤±è´¥ï¼š'+err.message) }
}

/* ====== å‘é€æ¶ˆæ¯ ====== */
async function sendMsg(){
  const input=$('#msg'); const text=input.value.trim(); if(!text) return;
  if(!dc || dc.readyState!=='open'){ addLine('sys','é€šé“æœªå°±ç»ª'); return; }
  if(!aesKey){ addLine('sys','å¯†é’¥æœªåå•†å®Œæˆ'); return; }
  const payload = await encryptText(text);
  dc.send(payload);
  addLine('me', text);
  input.value='';
}
$('#sendBtn').onclick = sendMsg;
$('#msg').addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMsg(); }});

/* ====== è¿æ¥æµç¨‹ï¼ˆæ‰‹åŠ¨å¤åˆ¶ç²˜è´´ä¿¡ä»¤ï¼‰ ====== */
$('#btnOffer').onclick = async ()=>{
  isStarter = true;
  await makePC();
  dc = pc.createDataChannel('chat',{ordered:true});
  bindDC();
  const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
  // ç­‰ ICE gathering ç»“æŸåï¼Œonicecandidate ä¼šæŠŠå®Œæ•´ SDP å†™å…¥ offerBox
  $('#dcState').textContent='openingâ€¦';
  logSys('å·²ç”Ÿæˆ Offerï¼ŒæŠŠä¸‹æ–¹å†…å®¹å‘ç»™å¯¹æ–¹ã€‚');
};

$('#btnAnswer').onclick = async ()=>{
  isStarter = false;
  await makePC();
  const remote = $('#remoteOffer').value.trim();
  if(!remote){ alert('å…ˆç²˜è´´å¯¹æ–¹çš„ Offer'); return; }
  const offer = JSON.parse(atob(remote));
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
  logSys('å·²ç”Ÿæˆ Answerï¼ŒæŠŠä¸‹æ–¹å†…å®¹å‘å›ç»™å¯¹æ–¹ã€‚');
};

$('#copyOffer').onclick = ()=> { const v=$('#offerBox').value; if(!v) return; navigator.clipboard.writeText(v); };
$('#copyAnswer').onclick = ()=> { const v=$('#answerBox').value; if(!v) return; navigator.clipboard.writeText(v); };

$('#remoteAnswer').addEventListener('change', async ()=>{
  const v = $('#remoteAnswer').value.trim(); if(!v) return;
  const answer = JSON.parse(atob(v));
  await pc.setRemoteDescription(new RTCSessionDescription(answer));
  logSys('Answer å·²è®¾ç½®ï¼Œç­‰å¾…é€šé“æ‰“å¼€â€¦');
});
</script>
</body>
</html>
